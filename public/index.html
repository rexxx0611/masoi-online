<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0a14">
<title>ğŸº Ma SÃ³i Online</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0a14;--panel:#12121f;--border:rgba(255,255,255,.08);
  --gold:#C8973A;--silver:#9AA4B8;--moon:#E8DCC8;
  --crimson:#DC143C;--night:#110d1e;
  --font:'Be Vietnam Pro',system-ui,-apple-system,sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;}
body{background:var(--bg);color:var(--moon);font-family:var(--font);min-height:100%;overflow-x:hidden;-webkit-font-smoothing:antialiased;}
body.night-bg{background:var(--night);}
button,input,select,textarea{font-family:var(--font);}

.screen{display:none;min-height:100vh;}
.screen.active{display:flex;flex-direction:column;align-items:center;}

/* ===== LOBBY ===== */
#scr-lobby{justify-content:center;padding:24px 20px;background:radial-gradient(ellipse at 50% 16%,rgba(200,151,58,.13) 0%,transparent 56%),var(--bg);}
.moon-svg{width:84px;height:84px;margin-bottom:8px;filter:drop-shadow(0 0 22px rgba(200,151,58,.45));}
.title{font-size:clamp(32px,9vw,54px);letter-spacing:.28em;color:var(--gold);font-weight:800;text-shadow:0 0 32px rgba(200,151,58,.45);margin-bottom:2px;}
.subtitle{font-size:12px;color:var(--silver);letter-spacing:.22em;margin-bottom:26px;font-weight:600;}
.card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:28px 22px;width:100%;max-width:420px;}
.card h2{font-size:15px;color:var(--gold);letter-spacing:.06em;margin-bottom:18px;text-align:center;font-weight:700;}
.ig{margin-bottom:13px;}
.lbl{display:block;font-size:10px;color:var(--silver);letter-spacing:.12em;margin-bottom:5px;font-weight:700;}
.inp{width:100%;background:rgba(0,0,0,.5);border:1px solid var(--border);border-radius:9px;padding:13px 15px;color:var(--moon);font-size:16px;outline:none;transition:border-color .2s;-webkit-appearance:none;appearance:none;}
.inp:focus{border-color:rgba(200,151,58,.55);}
.inp-code{text-transform:uppercase;letter-spacing:.32em;text-align:center;font-size:22px;font-weight:800;}
.btn-p{width:100%;background:linear-gradient(135deg,#8B0000,#C41E3A);border:none;border-radius:11px;padding:14px;color:#fff;font-size:15px;font-weight:700;cursor:pointer;transition:opacity .2s;margin-bottom:10px;-webkit-appearance:none;appearance:none;}
.btn-p:hover{opacity:.88;}.btn-p:active{opacity:.75;}
.btn-p:disabled{opacity:.35;cursor:not-allowed;}
.btn-s{width:100%;background:rgba(200,151,58,.1);border:1px solid rgba(200,151,58,.3);border-radius:11px;padding:12px;color:var(--gold);font-size:14px;font-weight:600;cursor:pointer;transition:background .2s;margin-bottom:10px;-webkit-appearance:none;appearance:none;}
.btn-s:hover,.btn-s:active{background:rgba(200,151,58,.22);}
.divider{text-align:center;color:var(--silver);font-size:11px;margin:10px 0;position:relative;font-weight:500;}
.divider::before,.divider::after{content:'';position:absolute;top:50%;width:36%;height:1px;background:var(--border);}
.divider::before{left:0;}.divider::after{right:0;}
.hint{font-size:11px;color:var(--silver);text-align:center;margin-top:18px;max-width:340px;line-height:1.8;opacity:.6;}

/* ===== ROOM ===== */
#scr-room{justify-content:flex-start;padding:0;}
.room-hd{width:100%;display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:rgba(0,0,0,.45);border-bottom:1px solid var(--border);}
.code-lbl{font-size:9px;color:var(--silver);letter-spacing:.14em;font-weight:700;display:block;margin-bottom:2px;}
.code-val{font-size:22px;letter-spacing:.3em;color:var(--gold);font-weight:800;cursor:pointer;}
.btn-sm{padding:7px 14px;font-size:12px;border-radius:8px;white-space:nowrap;}
.room-body{display:flex;flex-wrap:wrap;gap:14px;padding:14px;width:100%;max-width:920px;}
.players-area{flex:1;min-width:220px;}
.players-area h2{font-size:13px;color:var(--silver);letter-spacing:.08em;margin-bottom:11px;font-weight:700;}
.pgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(96px,1fr));gap:8px;}
.pcard{background:var(--panel);border:1px solid var(--border);border-radius:11px;padding:12px 8px;text-align:center;}
.pcard.host{border-color:rgba(200,151,58,.5);}.pcard.me{border-color:rgba(100,180,255,.4);}
.pavatar{font-size:26px;margin-bottom:4px;}.pname{font-size:12px;color:var(--moon);word-break:break-all;font-weight:500;}
.pbadge{font-size:10px;color:var(--silver);margin-top:3px;}
.cfg-panel{flex:1;min-width:220px;background:var(--panel);border:1px solid var(--border);border-radius:13px;padding:18px;}
.cfg-panel h3{font-size:13px;color:var(--gold);letter-spacing:.04em;margin-bottom:13px;font-weight:700;}
.role-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;margin-bottom:6px;border:1px solid var(--border);border-radius:9px;cursor:pointer;transition:background .2s;}
.role-item:hover,.role-item:active{background:rgba(200,151,58,.08);}
.rname{font-size:13px;color:var(--moon);font-weight:500;}
.rcnt{display:flex;align-items:center;gap:10px;}
.cbtn{background:rgba(255,255,255,.08);border:1px solid var(--border);border-radius:6px;color:var(--moon);width:28px;height:28px;cursor:pointer;font-size:17px;display:flex;align-items:center;justify-content:center;font-weight:700;-webkit-appearance:none;appearance:none;}
.cbtn:active{background:rgba(255,255,255,.22);}
.start-btn{width:100%;background:linear-gradient(135deg,#8B0000,#C41E3A);border:none;border-radius:11px;padding:14px;color:#fff;font-size:15px;font-weight:700;cursor:pointer;margin-top:13px;-webkit-appearance:none;appearance:none;}
.start-btn:disabled{opacity:.35;cursor:not-allowed;}
#start-msg{font-size:11px;color:var(--silver);text-align:center;margin-top:7px;}
.time-select{background:rgba(10,10,20,.9);border:1px solid rgba(200,151,58,.3);border-radius:7px;color:var(--gold);font-size:13px;font-weight:600;padding:5px 9px;cursor:pointer;outline:none;-webkit-appearance:none;appearance:none;}

/* ===== GAME ===== */
#scr-game{justify-content:flex-start;align-items:stretch;padding:0;}
.game-wrap{display:flex;flex-direction:column;height:100vh;max-height:100dvh;}

/* Phase banner */
.phase-banner{display:flex;align-items:center;gap:10px;padding:10px 14px;transition:background .5s;flex-shrink:0;}
.phase-banner.night{background:linear-gradient(90deg,rgba(20,8,36,.95),rgba(36,16,56,.95));}
.phase-banner.day{background:linear-gradient(90deg,rgba(38,28,12,.95),rgba(56,40,16,.95));}
.phase-banner.vote{background:linear-gradient(90deg,rgba(28,8,16,.95),rgba(60,16,28,.95));}
.ph-icon{font-size:26px;flex-shrink:0;}
.ph-info{flex:1;min-width:0;}
.ph-title{font-size:15px;font-weight:800;color:var(--gold);}
.ph-sub{font-size:10px;color:var(--silver);font-weight:500;margin-top:1px;}

/* Timer ring â€” Fix 2 */
.timer-wrap{display:flex;flex-direction:column;align-items:center;gap:2px;flex-shrink:0;}
.timer-ring-outer{position:relative;width:52px;height:52px;display:flex;align-items:center;justify-content:center;}
.timer-ring-svg{position:absolute;inset:0;width:52px;height:52px;transform:rotate(-90deg);}
.trb{fill:none;stroke:rgba(255,255,255,.08);stroke-width:4;}
.trf{fill:none;stroke:var(--gold);stroke-width:4;stroke-linecap:round;stroke-dasharray:138.23;stroke-dashoffset:0;transition:stroke .3s;}
.trf.warn{stroke:var(--crimson);}
.timer-num{position:relative;font-size:12px;font-weight:800;color:var(--gold);font-variant-numeric:tabular-nums;line-height:1;z-index:1;}
.timer-num.warn{color:var(--crimson);}
.phase-lbl{font-size:8px;color:var(--silver);letter-spacing:.06em;font-weight:700;text-align:center;max-width:60px;}

.exit-btn{background:rgba(139,0,0,.2);border:1px solid rgba(220,20,60,.28);color:var(--crimson);border-radius:7px;padding:6px 11px;cursor:pointer;font-size:13px;font-weight:700;flex-shrink:0;-webkit-appearance:none;appearance:none;}
.exit-btn:active{background:rgba(139,0,0,.4);}

.game-grid{display:flex;flex:1;overflow:hidden;}
.stage{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:10px;-webkit-overflow-scrolling:touch;}
.section-hd{font-size:9px;color:var(--silver);letter-spacing:.18em;margin-bottom:6px;padding:0 2px;font-weight:700;}
.gp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(76px,1fr));gap:6px;}

/* Player card â€” no inline onclick (Fix 4) */
.gp{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px 6px;text-align:center;position:relative;-webkit-user-select:none;user-select:none;transition:border-color .2s,background .2s,transform .12s;}
.gp.can-target{cursor:pointer;border-color:rgba(220,20,60,.35);}
.gp.can-target:hover{border-color:var(--crimson);background:rgba(220,20,60,.09);transform:translateY(-2px);}
.gp.can-target:active{transform:scale(.95);background:rgba(220,20,60,.18);}
.gp.dead{opacity:.36;filter:grayscale(.65);}
.gp-av{font-size:22px;margin-bottom:3px;line-height:1;}
.gp-name{font-size:11px;color:var(--moon);word-break:break-all;font-weight:500;}
.gp-role{font-size:9px;color:var(--silver);margin-top:3px;opacity:.6;}
.vcnt{position:absolute;top:-7px;right:-7px;background:var(--crimson);color:#fff;border-radius:50%;width:20px;height:20px;font-size:10px;font-weight:800;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,.5);}
.tag-me{font-size:8px;color:#64B4FF;background:rgba(100,180,255,.15);border-radius:3px;padding:1px 3px;margin-left:2px;font-weight:600;}
.dead-sec{margin-top:4px;opacity:.6;}

/* Role info column â€” Fix 3 */
.role-info-col{width:128px;min-width:110px;border-left:1px solid var(--border);background:rgba(0,0,0,.18);padding:8px 6px;overflow-y:auto;flex-shrink:0;-webkit-overflow-scrolling:touch;}
@media(max-width:640px){.role-info-col{display:none;}}
.col-hd{font-size:8px;color:var(--silver);letter-spacing:.18em;margin-bottom:7px;font-weight:700;}
.ri-chip{display:flex;align-items:center;gap:6px;padding:6px 7px;margin-bottom:4px;border:1px solid var(--border);border-radius:8px;background:rgba(255,255,255,.03);cursor:pointer;transition:background .18s,border-color .18s;-webkit-tap-highlight-color:rgba(200,151,58,.15);}
.ri-chip:hover,.ri-chip:active{background:rgba(200,151,58,.12);border-color:rgba(200,151,58,.35);}
.ri-icon{font-size:18px;flex-shrink:0;line-height:1;}
.ri-info{flex:1;min-width:0;}
.ri-name{font-size:10px;color:var(--moon);font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ri-cnt{font-size:9px;color:var(--silver);margin-top:1px;}
.ri-cnt b{color:var(--gold);}

/* Sidebar */
.sidebar{width:208px;min-width:172px;display:flex;flex-direction:column;border-left:1px solid var(--border);background:rgba(0,0,0,.22);flex-shrink:0;}
@media(max-width:540px){.game-grid{flex-direction:column;}.role-info-col{display:none;}.sidebar{width:100%;min-width:auto;border-left:none;border-top:1px solid var(--border);max-height:255px;}}
.box-hd{font-size:8px;color:var(--silver);letter-spacing:.2em;margin-bottom:8px;font-weight:700;}
.my-role-box,.action-box{padding:11px 12px;border-bottom:1px solid var(--border);}
.role-pill{display:flex;gap:9px;align-items:flex-start;}
.rp-icon{font-size:26px;line-height:1;flex-shrink:0;}
.rp-name{font-size:13px;font-weight:800;color:var(--gold);}
.rp-team{font-size:10px;color:var(--silver);margin-top:2px;font-weight:500;}
.rp-ability{font-size:10px;color:var(--silver);margin-top:4px;line-height:1.5;opacity:.8;}
.action-box{min-height:66px;}
.dim-text{font-size:12px;color:var(--silver);opacity:.6;font-weight:400;}
.log-box{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:9px 10px;}
.log-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.log-scroll::-webkit-scrollbar{width:3px;}
.log-scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.log-line{padding:3px 0;border-bottom:1px solid rgba(255,255,255,.03);font-size:11px;line-height:1.6;}
.log-line.night{color:#9090FF;}.log-line.death{color:var(--crimson);}
.log-line.day{color:#C8973A;}.log-line.vote{color:#CC88FF;}
.log-line.win{color:#88FF88;font-weight:700;}.log-line.chat{color:#64B4FF;}
.log-line.wolf{color:#FF6060;}
.majority-indicator{font-size:11px;color:var(--silver);text-align:center;padding:5px 10px;background:rgba(139,0,0,.12);border:1px solid rgba(220,20,60,.18);border-radius:7px;margin-bottom:7px;font-weight:500;}

.game-bottom{display:flex;gap:8px;padding:9px 10px;border-top:1px solid var(--border);background:rgba(0,0,0,.35);flex-shrink:0;}
.chat-inp{flex:1;background:rgba(0,0,0,.5);border:1px solid var(--border);border-radius:9px;padding:10px 13px;color:var(--moon);font-size:15px;outline:none;-webkit-appearance:none;appearance:none;}
.chat-inp::placeholder{color:rgba(176,184,200,.38);}
.send-btn{background:rgba(200,151,58,.13);border:1px solid rgba(200,151,58,.3);border-radius:9px;padding:10px 14px;color:var(--gold);cursor:pointer;font-size:14px;font-weight:700;white-space:nowrap;-webkit-appearance:none;appearance:none;}
.send-btn:active{background:rgba(200,151,58,.28);}

/* ===== END ===== */
#scr-end{justify-content:center;padding:24px;background:radial-gradient(ellipse at 50% 28%,rgba(200,151,58,.1) 0%,transparent 58%),var(--bg);}
.end-content{text-align:center;width:100%;max-width:500px;}
.end-trophy{font-size:80px;display:block;margin-bottom:12px;animation:trophyPop .65s cubic-bezier(.2,1,.4,1);}
@keyframes trophyPop{0%{transform:scale(0)rotate(-15deg);}80%{transform:scale(1.1)rotate(2deg);}100%{transform:scale(1)rotate(0);}}
.end-title{font-size:clamp(16px,4vw,23px);color:var(--gold);font-weight:800;margin-bottom:14px;line-height:1.4;}
.end-winners{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-bottom:18px;}
.winner-chip{background:rgba(200,151,58,.18);border:1px solid rgba(200,151,58,.4);border-radius:20px;padding:6px 16px;font-size:13px;color:var(--gold);font-weight:600;}
.end-roles{background:var(--panel);border:1px solid var(--border);border-radius:13px;padding:14px;margin-bottom:18px;text-align:left;}
.end-player{display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,.05);font-size:13px;font-weight:500;}
.end-player:last-child{border-bottom:none;}.end-player.dead{opacity:.42;}

/* ===== MODALS ===== */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:200;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:24px 20px;width:100%;max-width:460px;max-height:90vh;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.modal-icon{font-size:46px;display:block;text-align:center;margin-bottom:8px;line-height:1.2;}
.modal h2{font-size:18px;font-weight:800;color:var(--gold);text-align:center;margin-bottom:10px;}
.modal p{font-size:13px;color:var(--silver);line-height:1.7;margin-bottom:10px;text-align:center;}
.modal-team{text-align:center;font-size:12px;margin-bottom:10px;font-weight:700;}
.modal-btns{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:14px;}
.mbtn{padding:11px 22px;border-radius:11px;font-size:14px;font-weight:700;cursor:pointer;border:none;transition:opacity .15s;-webkit-appearance:none;appearance:none;}
.mbtn.p{background:linear-gradient(135deg,#8B0000,#C41E3A);color:#fff;}
.mbtn.s{background:rgba(200,151,58,.13);border:1px solid rgba(200,151,58,.3);color:var(--gold);}
.mbtn:active{opacity:.72;}.mbtn:disabled{opacity:.32;cursor:not-allowed;}
.targets-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(118px,1fr));gap:8px;margin:12px 0;max-height:256px;overflow-y:auto;-webkit-overflow-scrolling:touch;}
.target-btn{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:9px;padding:10px 8px;color:var(--moon);font-size:13px;cursor:pointer;text-align:center;font-weight:500;-webkit-appearance:none;appearance:none;width:100%;}
.target-btn:hover,.target-btn:active{border-color:rgba(200,151,58,.5);background:rgba(200,151,58,.1);}
.target-btn.sel{border-color:var(--gold);background:rgba(200,151,58,.18);color:var(--gold);font-weight:700;}
.target-btn:disabled{opacity:.32;cursor:not-allowed;}
.wolf-pack{font-size:12px;color:#FF9090;text-align:center;margin-bottom:8px;font-weight:500;}
.seer-result{font-size:16px;font-weight:800;text-align:center;padding:16px;border-radius:11px;margin:10px 0;}
.seer-result.good{background:rgba(40,130,40,.14);color:#88FF88;border:1px solid rgba(80,200,80,.28);}
.seer-result.evil{background:rgba(140,16,16,.2);color:#FF8888;border:1px solid rgba(210,50,50,.3);}

.notif{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--panel);border:1px solid var(--border);border-radius:11px;padding:12px 20px;font-size:13px;color:var(--moon);font-weight:500;transition:transform .3s ease;z-index:300;white-space:nowrap;max-width:90vw;}
.notif.show{transform:translateX(-50%) translateY(0);}
.notif.error{border-color:rgba(220,20,60,.5);color:var(--crimson);}
.notif.success{border-color:rgba(80,200,80,.4);color:#88FF88;}
</style>
</head>
<body>
<div id="app">

<!-- LOBBY -->
<div id="scr-lobby" class="screen active">
  <svg class="moon-svg" viewBox="0 0 100 100" fill="none">
    <path d="M50 10 C28 10,10 28,10 50 C10 72,28 90,50 90 C38 82,30 66,32 50 C34 36,44 24,56 20 C54 16,52 12,50 10Z" fill="rgba(232,220,200,.92)"/>
    <circle cx="50" cy="50" r="42" stroke="rgba(232,220,200,.12)" stroke-width=".5" fill="none"/>
  </svg>
  <div class="title">MA SÃ“I</div>
  <div class="subtitle">âœ¦ CHÆ I ONLINE âœ¦</div>
  <div class="card">
    <h2>âš” BÆ°á»›c vÃ o lÃ ng</h2>
    <div class="ig"><label class="lbl">TÃŠN Cá»¦A Báº N</label>
      <input id="inp-name" class="inp" placeholder="TÃªn hiá»ƒn thá»‹..." maxlength="18" autocomplete="off" autocorrect="off" spellcheck="false"/>
    </div>
    <button class="btn-p" id="btn-create">ğŸ  Táº¡o PhÃ²ng Má»›i</button>
    <div class="divider">hoáº·c tham gia phÃ²ng cÃ³ sáºµn</div>
    <div class="ig"><label class="lbl">MÃƒ PHÃ’NG</label>
      <input id="inp-code" class="inp inp-code" placeholder="XXXXXX" maxlength="6" autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false"/>
    </div>
    <button class="btn-s" id="btn-join">ğŸšª Tham Gia PhÃ²ng</button>
  </div>
  <div class="hint">ğŸ’¡ Chia sáº» mÃ£ phÃ²ng Ä‘á»ƒ báº¡n bÃ¨ tham gia tá»« báº¥t ká»³ thiáº¿t bá»‹ â€” Safari, Chrome Ä‘á»u chÆ¡i Ä‘Æ°á»£c!</div>
</div>

<!-- ROOM -->
<div id="scr-room" class="screen">
  <div class="room-hd">
    <div>
      <span class="code-lbl">MÃƒ PHÃ’NG (báº¥m Ä‘á»ƒ sao chÃ©p)</span>
      <span id="room-code" class="code-val">------</span>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <span id="room-pc" style="font-size:12px;color:var(--silver);font-weight:600"></span>
      <button class="btn-s btn-sm" id="btn-leave-room">â† Rá»i</button>
    </div>
  </div>
  <div class="room-body">
    <div class="players-area">
      <h2>ğŸ‘¥ NGÆ¯á»œI CHÆ I</h2>
      <div id="room-grid" class="pgrid"></div>
      <div id="room-wait" style="font-size:12px;color:var(--silver);margin-top:10px;font-weight:500;"></div>
    </div>
    <div id="cfg-panel" class="cfg-panel">
      <h3>âš™ CÃ i Ä‘áº·t vai trÃ² <span style="font-size:10px;opacity:.42;font-weight:400">(báº¥m tÃªn Ä‘á»ƒ xem mÃ´ táº£)</span></h3>
      <div id="cfg-roles"></div>
      <div class="role-item" style="border-color:rgba(200,151,58,.2);cursor:default;">
        <span class="rname">â± Thá»i gian tháº£o luáº­n</span>
        <select id="discuss-time-select" class="time-select">
          <option value="60">1 phÃºt</option><option value="120">2 phÃºt</option>
          <option value="180">3 phÃºt</option><option value="240">4 phÃºt</option>
          <option value="300">5 phÃºt</option>
        </select>
      </div>
      <button id="start-btn" class="start-btn" disabled>ğŸŒ™ Báº¯t Ä‘áº§u</button>
      <div id="start-msg"></div>
    </div>
  </div>
</div>

<!-- GAME -->
<div id="scr-game" class="screen">
  <div class="game-wrap">
    <div id="phase-banner" class="phase-banner day">
      <span id="phase-icon" class="ph-icon">â˜€ï¸</span>
      <div class="ph-info">
        <div id="phase-title" class="ph-title">Ban NgÃ y</div>
        <div id="phase-sub" class="ph-sub">Tháº£o luáº­n!</div>
      </div>
      <!-- FIX 2: SVG ring timer â€” synced from server, visible to all -->
      <div class="timer-wrap">
        <div class="timer-ring-outer">
          <svg class="timer-ring-svg" viewBox="0 0 52 52">
            <circle class="trb" cx="26" cy="26" r="22"/>
            <circle id="trf" class="trf" cx="26" cy="26" r="22"/>
          </svg>
          <span id="timer-num" class="timer-num">â€”</span>
        </div>
        <div id="phase-lbl" class="phase-lbl"></div>
      </div>
      <button id="btn-exit" class="exit-btn">âœ•</button>
    </div>

    <div class="game-grid">
      <div class="stage">
        <div>
          <div class="section-hd">CÃ’N Sá»NG (<span id="alive-cnt">0</span>)</div>
          <div id="alive-list" class="gp-grid"></div>
        </div>
        <div class="dead-sec">
          <div class="section-hd">ÄÃƒ CHáº¾T (<span id="dead-cnt">0</span>)</div>
          <div id="dead-list" class="gp-grid"></div>
        </div>
      </div>

      <!-- FIX 3: Role info column with clickable chips -->
      <div class="role-info-col">
        <div class="col-hd">VAI TRONG VÃN</div>
        <div id="role-info-list"></div>
      </div>

      <div class="sidebar">
        <div class="my-role-box">
          <div class="box-hd">VAI Cá»¦A Báº N</div>
          <div class="role-pill">
            <span id="my-role-icon" class="rp-icon">â“</span>
            <div>
              <div id="my-role-name" class="rp-name">ChÆ°a rÃµ</div>
              <div id="my-role-team" class="rp-team"></div>
              <div id="my-role-ability" class="rp-ability"></div>
            </div>
          </div>
        </div>
        <div class="action-box">
          <div class="box-hd">HÃ€NH Äá»˜NG</div>
          <div id="action-content"></div>
        </div>
        <div class="log-box">
          <div class="box-hd" style="margin-bottom:5px">ğŸ“œ NHáº¬T KÃ</div>
          <div id="log-msgs" class="log-scroll"></div>
        </div>
      </div>
    </div>

    <div class="game-bottom">
      <input id="chat-inp" class="chat-inp" placeholder="Nháº¯n tin vá»›i lÃ ng..." maxlength="120" autocomplete="off" autocorrect="off"/>
      <button id="btn-send" class="send-btn">Gá»­i â†’</button>
    </div>
  </div>
</div>

<!-- END -->
<div id="scr-end" class="screen">
  <div class="end-content">
    <span id="end-trophy" class="end-trophy">ğŸ†</span>
    <div id="end-title" class="end-title"></div>
    <div id="end-winners" class="end-winners"></div>
    <div id="end-roles" class="end-roles"></div>
    <button class="btn-p" id="btn-return" style="max-width:260px;margin:0 auto;display:block">ğŸ  Vá» sáº£nh chá»</button>
  </div>
</div>
</div>

<!-- MODALS -->
<div id="role-modal" class="modal-bg">
  <div class="modal">
    <span id="reveal-icon" class="modal-icon">ğŸ­</span>
    <h2 id="reveal-name"></h2>
    <div id="reveal-team" class="modal-team"></div>
    <p id="reveal-desc"></p>
    <p id="reveal-ability" style="font-size:12px;color:var(--gold);font-weight:700;text-align:center;margin-top:0;"></p>
    <div class="modal-btns"><button class="mbtn p" id="btn-role-ok">TÃ´i Ä‘Ã£ hiá»ƒu âœ“</button></div>
  </div>
</div>

<div id="death-modal" class="modal-bg">
  <div class="modal">
    <span class="modal-icon">ğŸ’€</span><h2>Báº¡n Ä‘Ã£ bá»‹ loáº¡i!</h2>
    <p id="death-reason"></p>
    <p id="death-role" style="color:var(--gold);font-size:14px;font-weight:700;"></p>
    <div class="modal-btns"><button class="mbtn s" id="btn-death-ok">Tiáº¿p tá»¥c xem</button></div>
  </div>
</div>

<div id="vote-modal" class="modal-bg">
  <div class="modal">
    <span class="modal-icon">âš–</span><h2>XÃ¡c nháº­n bá» phiáº¿u</h2>
    <p>Báº¡n muá»‘n treo cá»• <strong id="vote-confirm-name" style="color:var(--crimson)"></strong>?</p>
    <div class="modal-btns">
      <button class="mbtn p" id="btn-vote-confirm">âœ“ XÃ¡c nháº­n</button>
      <button class="mbtn s" id="btn-vote-cancel">âœ— Há»§y</button>
    </div>
  </div>
</div>

<div id="wolf-modal" class="modal-bg">
  <div class="modal" style="max-width:500px">
    <span class="modal-icon">ğŸº</span><h2>Ma SÃ³i thá»©c dáº­y!</h2>
    <div id="wolf-pack-info" class="wolf-pack"></div>
    <p style="margin-bottom:6px;font-size:13px;">Chá»n náº¡n nhÃ¢n (cáº§n Ä‘a sá»‘ báº§y Ä‘á»“ng Ã½):</p>
    <div id="wolf-targets" class="targets-grid"></div>
    <div style="margin:10px 0;padding:10px;background:rgba(139,0,0,.18);border-radius:9px;border:1px solid rgba(220,20,60,.2)">
      <div style="font-size:9px;color:var(--silver);margin-bottom:4px;letter-spacing:.1em;font-weight:700;">PHIáº¾U Cá»¦A Báº¦Y:</div>
      <div id="wolf-vote-status"><span style="opacity:.45;font-size:12px">ChÆ°a ai chá»n...</span></div>
      <div id="wolf-consensus-label" style="font-size:13px;color:#88FF88;margin-top:6px;font-weight:700;"></div>
    </div>
    <div class="modal-btns">
      <button id="wolf-confirm-btn" class="mbtn p" disabled>ğŸº XÃ¡c nháº­n!</button>
      <button id="btn-wolf-skip" class="mbtn s">ğŸ˜´ Bá» qua</button>
    </div>
  </div>
</div>

<div id="seer-modal" class="modal-bg">
  <div class="modal">
    <span class="modal-icon">ğŸ”®</span><h2>TiÃªn Tri thá»©c dáº­y!</h2>
    <p>Chá»n ngÆ°á»i Ä‘á»ƒ xem báº£n cháº¥t (chá»‰ phÃ¡t hiá»‡n Ma SÃ³i):</p>
    <div id="seer-targets" class="targets-grid"></div>
    <div class="modal-btns"><button id="seer-confirm-btn" class="mbtn p" disabled>ğŸ”® NhÃ¬n tháº¥u!</button></div>
  </div>
</div>

<div id="seer-result-modal" class="modal-bg">
  <div class="modal">
    <span class="modal-icon">ğŸ”®</span><h2>NhÃ£n ThiÃªn LÃ½ Tháº¥y...</h2>
    <div id="seer-result-text" class="seer-result good"></div>
    <div class="modal-btns"><button class="mbtn s" id="btn-seer-ok">ÄÃ£ hiá»ƒu</button></div>
  </div>
</div>

<div id="witch-modal" class="modal-bg">
  <div class="modal">
    <span class="modal-icon">ğŸ§™â€â™€ï¸</span><h2>PhÃ¹ Thá»§y thá»©c dáº­y!</h2>
    <p style="font-size:11px;color:#FFAA44;margin-bottom:8px;font-weight:600;">âš  Chá»‰ 1 bÃ¬nh cho cáº£ game! DÃ¹ng Ä‘á»ƒ cá»©u HOáº¶C giáº¿t.</p>
    <p id="witch-attacked-info" style="font-weight:700;margin-bottom:14px;font-size:14px;"></p>
    <div class="modal-btns" style="flex-direction:column;gap:8px;">
      <button id="witch-save-btn" class="mbtn p">ğŸ’Š Cá»©u ngÆ°á»i bá»‹ táº¥n cÃ´ng</button>
      <button id="witch-kill-open-btn" class="mbtn s">â˜  DÃ¹ng bÃ¬nh Ä‘á»™c</button>
      <button id="btn-witch-skip" class="mbtn s">ğŸ˜´ Bá» qua Ä‘Ãªm nay</button>
    </div>
  </div>
</div>

<div id="witch-kill-modal" class="modal-bg">
  <div class="modal">
    <span class="modal-icon">â˜ </span><h2>Chá»n má»¥c tiÃªu Ä‘áº§u Ä‘á»™c!</h2>
    <p style="color:#FFAA44;font-size:12px;font-weight:600;">Sau khi dÃ¹ng, bÃ¬nh thuá»‘c máº¥t vÄ©nh viá»…n!</p>
    <div id="witch-kill-targets" class="targets-grid"></div>
    <div class="modal-btns">
      <button id="witch-kill-confirm" class="mbtn p" disabled>â˜  Äáº§u Ä‘á»™c!</button>
      <button id="btn-witch-kill-back" class="mbtn s">â† Quay láº¡i</button>
    </div>
  </div>
</div>

<div id="guard-modal" class="modal-bg">
  <div class="modal">
    <span class="modal-icon">ğŸ›¡ï¸</span><h2>Báº£o Vá»‡ thá»©c dáº­y!</h2>
    <p>Chá»n 1 ngÆ°á»i báº£o vá»‡ khá»i sÃ³i. KhÃ´ng báº£o vá»‡ cÃ¹ng ngÆ°á»i 2 Ä‘Ãªm liÃªn tiáº¿p.</p>
    <div id="guard-targets" class="targets-grid"></div>
    <div class="modal-btns">
      <button id="guard-confirm-btn" class="mbtn p" disabled>ğŸ›¡ï¸ Báº£o vá»‡!</button>
      <button id="btn-guard-skip" class="mbtn s">ğŸ˜´ Bá» qua</button>
    </div>
  </div>
</div>

<div id="vamp-modal" class="modal-bg">
  <div class="modal">
    <span class="modal-icon">ğŸ§›</span><h2>Ma CÃ  Rá»“ng thá»©c dáº­y!</h2>
    <p>Chá»n ngÆ°á»i hÃºt mÃ¡u. Náº¡n nhÃ¢n cháº¿t sau bá» phiáº¿u ngÃ y mai.</p>
    <div id="vamp-targets" class="targets-grid"></div>
    <div class="modal-btns">
      <button id="vamp-confirm-btn" class="mbtn p" disabled>ğŸ§› HÃºt mÃ¡u!</button>
      <button id="btn-vamp-skip" class="mbtn s">ğŸ˜´ Bá» qua</button>
    </div>
  </div>
</div>

<div id="hunter-modal" class="modal-bg">
  <div class="modal">
    <span class="modal-icon">ğŸ¹</span><h2>Thá»£ SÄƒn ra tay!</h2>
    <p>Báº¡n sáº¯p cháº¿t! Chá»n ngay 1 ngÆ°á»i Ä‘á»ƒ báº¯n háº¡!</p>
    <div id="hunter-timer-display" style="font-size:36px;color:var(--crimson);text-align:center;font-weight:900;margin:6px 0;font-variant-numeric:tabular-nums;">10</div>
    <div id="hunter-targets" class="targets-grid"></div>
    <div class="modal-btns"><button id="hunter-fire-btn" class="mbtn p" disabled>ğŸ¹ Báº¯n!</button></div>
  </div>
</div>

<div id="notif" class="notif"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
'use strict';
// ================================================================
//  MA SÃ“I ONLINE â€” Client
//  Fix 1: SVG ring countdown timer synced from server
//  Fix 2: Timer visible to all (via TIMER_START socket event)
//  Fix 3: Role info column with clickable chips â†’ role modal
//  Fix 4: Safari iOS vote â€” event delegation, no inline onclick
// ================================================================

const ROLES = {
  villager:{ name:'DÃ¢n LÃ ng',    icon:'ğŸ‘¨â€ğŸŒ¾', team:'village', desc:'KhÃ´ng cÃ³ chá»©c nÄƒng Ä‘áº·c biá»‡t. HÃ£y dÃ¹ng trÃ­ tuá»‡ Ä‘á»ƒ tÃ¬m ra káº» thÃ¹!', ability:'Bá» phiáº¿u treo cá»• ban ngÃ y.' },
  wolf:    { name:'Ma SÃ³i',       icon:'ğŸº',  team:'wolf',    desc:'Má»—i Ä‘Ãªm báº§y sÃ³i cÃ¹ng vote chá»n 1 náº¡n nhÃ¢n. Tháº¯ng khi sá»‘ sÃ³i â‰¥ sá»‘ ngÆ°á»i cÃ²n láº¡i.', ability:'ÄÃªm: vote chá»n náº¡n nhÃ¢n cÃ¹ng báº§y.' },
  seer:    { name:'TiÃªn Tri',     icon:'ğŸ”®',  team:'village', desc:'Má»—i Ä‘Ãªm xem báº£n cháº¥t cá»§a 1 ngÆ°á»i â€” chá»‰ phÃ¡t hiá»‡n Ma SÃ³i, khÃ´ng phÃ¡t hiá»‡n vai Ã¡c khÃ¡c.', ability:'ÄÃªm: nhÃ¬n tháº¥u báº£n cháº¥t 1 ngÆ°á»i.' },
  witch:   { name:'PhÃ¹ Thá»§y',     icon:'ğŸ§™â€â™€ï¸', team:'village', desc:'CÃ³ 1 bÃ¬nh thuá»‘c duy nháº¥t cho cáº£ game. Cá»©u ngÆ°á»i bá»‹ sÃ³i táº¥n cÃ´ng HOáº¶C Ä‘áº§u Ä‘á»™c 1 ngÆ°á»i.', ability:'1 láº§n/game: cá»©u hoáº·c giáº¿t.' },
  hunter:  { name:'Thá»£ SÄƒn',      icon:'ğŸ¹',  team:'village', desc:'Khi bá»‹ loáº¡i cÃ³ 10 giÃ¢y Ä‘á»ƒ báº¯n háº¡ 1 ngÆ°á»i. KhÃ´ng chá»n ká»‹p thÃ¬ máº¥t chá»©c nÄƒng.', ability:'Khi cháº¿t: báº¯n 1 ngÆ°á»i (10 giÃ¢y).' },
  guard:   { name:'Báº£o Vá»‡',       icon:'ğŸ›¡ï¸',  team:'village', desc:'Má»—i Ä‘Ãªm báº£o vá»‡ 1 ngÆ°á»i khá»i bá»‹ sÃ³i táº¥n cÃ´ng. KhÃ´ng báº£o vá»‡ cÃ¹ng ngÆ°á»i 2 Ä‘Ãªm liÃªn tiáº¿p. CÃ³ thá»ƒ tá»± báº£o vá»‡.', ability:'ÄÃªm: báº£o vá»‡ 1 ngÆ°á»i khá»i sÃ³i.' },
  cursed:  { name:'Káº» Bá»‹ Nguyá»n', icon:'ğŸ˜ˆ',  team:'village', desc:'Ban Ä‘áº§u á»Ÿ phe DÃ¢n LÃ ng. Náº¿u bá»‹ sÃ³i cáº¯n sáº½ biáº¿n thÃ nh Ma SÃ³i thay vÃ¬ cháº¿t!', ability:'Biáº¿n thÃ nh sÃ³i khi bá»‹ sÃ³i cáº¯n.' },
  bored:   { name:'Káº» ChÃ¡n Äá»i',  icon:'ğŸ˜‘',  team:'none',    desc:'Má»¥c tiÃªu duy nháº¥t lÃ  bá»‹ lÃ ng treo cá»•. Náº¿u cháº¿t cÃ¡ch khÃ¡c thÃ¬ thua!', ability:'Tháº¯ng khi bá»‹ lÃ ng treo cá»•.' },
  vampire: { name:'Ma CÃ  Rá»“ng',   icon:'ğŸ§›',  team:'none',    desc:'Má»—i Ä‘Ãªm hÃºt mÃ¡u 1 ngÆ°á»i. Náº¡n nhÃ¢n khÃ´ng cháº¿t ngay â€” cháº¿t sau khi bá» phiáº¿u ngÃ y hÃ´m sau.', ability:'ÄÃªm: hÃºt mÃ¡u â€” náº¡n nhÃ¢n cháº¿t trÃ¬ hoÃ£n.' }
};
const ROLE_ORDER = ['wolf','vampire','guard','seer','witch','hunter','cursed','bored','villager'];
const TC = { village:'#64B4FF', wolf:'#FF4444', none:'#AAAAAA' };
const TN = { village:'DÃ¢n LÃ ng ğŸŸ¦', wolf:'Ma SÃ³i ğŸ”´', none:'Trung Láº­p âš«' };
const AVATARS = ['ğŸ±','ğŸ¦Š','ğŸ»','ğŸ¦','ğŸ¯','ğŸº','ğŸ¦','ğŸ¸','ğŸ¦„','ğŸ™','ğŸ¦‹','ğŸ§','ğŸ¦…','ğŸ²','ğŸ¦€','ğŸ¬','ğŸ¦‰','ğŸ¼','ğŸ¦Œ','ğŸ¨'];

let socket, myId, myName, myAvatar, myRole;
let currentCode='', isHost=false, gameState=null, pendingVoteTarget=null;
let timerIV=null, timerTotal=1, timerEnd=0;
let roleConfig={ wolf:1, seer:1, witch:1, hunter:1, guard:1, cursed:0, bored:0, vampire:0, villager:0 };
const RING_C = 2 * Math.PI * 22; // r=22

function $(id){ return document.getElementById(id); }
function escH(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ----------------------------------------------------------------
//  INIT â€” all event listeners via addEventListener (no inline onclick)
//  This is critical for Safari iOS compatibility
// ----------------------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
  // Lobby
  $('btn-create').addEventListener('click', createRoom);
  $('btn-join').addEventListener('click', joinRoom);
  $('inp-name').addEventListener('keydown', e => { if(e.key==='Enter') createRoom(); });
  $('inp-code').addEventListener('keydown', e => { if(e.key==='Enter') joinRoom(); });

  // Room
  $('btn-leave-room').addEventListener('click', leaveRoom);
  $('room-code').addEventListener('click', copyCode);
  $('start-btn').addEventListener('click', startGame);

  // Game
  $('btn-exit').addEventListener('click', leaveGame);
  $('btn-send').addEventListener('click', sendChat);
  $('chat-inp').addEventListener('keydown', e => { if(e.key==='Enter') sendChat(); });

  // FIX 4: player grid delegation â€” click AND touchend for Safari iOS
  const aliveList = $('alive-list');
  aliveList.addEventListener('click', onGridClick);
  aliveList.addEventListener('touchend', onGridTouch, { passive: false });

  // Modals
  $('btn-role-ok').addEventListener('click', () => closeModal('role-modal'));
  $('btn-death-ok').addEventListener('click', () => closeModal('death-modal'));
  $('btn-vote-confirm').addEventListener('click', confirmVote);
  $('btn-vote-cancel').addEventListener('click', () => closeModal('vote-modal'));
  $('wolf-confirm-btn').addEventListener('click', wolfConfirm);
  $('btn-wolf-skip').addEventListener('click', () => closeModal('wolf-modal'));
  $('seer-confirm-btn').addEventListener('click', seerConfirm);
  $('btn-seer-ok').addEventListener('click', () => closeModal('seer-result-modal'));
  $('witch-save-btn').addEventListener('click', doWitchSave);
  $('witch-kill-open-btn').addEventListener('click', showWitchKillModal);
  $('btn-witch-skip').addEventListener('click', () => closeModal('witch-modal'));
  $('btn-witch-kill-back').addEventListener('click', () => { closeModal('witch-kill-modal'); openModal('witch-modal'); });
  $('guard-confirm-btn').addEventListener('click', guardConfirm);
  $('btn-guard-skip').addEventListener('click', () => closeModal('guard-modal'));
  $('vamp-confirm-btn').addEventListener('click', vampireConfirm);
  $('btn-vamp-skip').addEventListener('click', () => closeModal('vamp-modal'));
  $('hunter-fire-btn').addEventListener('click', hunterFire);
  $('btn-return').addEventListener('click', returnToLobby);

  // Close modal on backdrop tap
  document.querySelectorAll('.modal-bg').forEach(bg => {
    bg.addEventListener('click', e => { if(e.target === bg) bg.style.display = 'none'; });
  });

  initSocket();
});

// ----------------------------------------------------------------
//  FIX 4: Touch/Click delegation for player vote
// ----------------------------------------------------------------
let _touchScrolled = false;
document.addEventListener('touchmove', () => { _touchScrolled = true; }, { passive:true });

function onGridTouch(e) {
  if (_touchScrolled) return;
  const card = e.target.closest('.gp.can-target');
  if (!card) return;
  e.preventDefault(); // stops ghost click on iOS
  castVote(card.dataset.pid);
}
function onGridClick(e) {
  const card = e.target.closest('.gp.can-target');
  if (card && card.dataset.pid) castVote(card.dataset.pid);
}
document.addEventListener('touchstart', () => { _touchScrolled = false; }, { passive:true });

// ----------------------------------------------------------------
//  SOCKET
// ----------------------------------------------------------------
function initSocket() {
  socket = io({ transports:['websocket','polling'] });
  socket.on('connect',    () => { myId = socket.id; });
  socket.on('disconnect', () => notify('Máº¥t káº¿t ná»‘i server!','err'));
  socket.on('ERR',         d => notify(d.msg,'err'));

  socket.on('ROOM_JOINED', d => {
    currentCode=d.code; myId=d.me.id; isHost=d.me.isHost;
    updateRoomUI(d.room); showScreen('room');
    if(isHost) setupConfig();
  });
  socket.on('ROOM_UPDATE', d => updateRoomUI(d.room));

  socket.on('YOUR_ROLE', d => { myRole=d.role; renderMyRole(); showRoleModal(d.role); });
  socket.on('CURSED_TURNED', d => { myRole='wolf'; notify(d.msg,'err'); renderMyRole(); showRoleModal('wolf'); });

  socket.on('GAME_STARTED', d => {
    gameState=d.gameState;
    clearLog(); clearTimerUI();
    showScreen('game'); renderGameUI(); renderRoleInfoCol();
  });
  socket.on('PHASE_CHANGE', d => { gameState=d.gameState; renderPhase(d.phase); renderGameUI(); });
  socket.on('STATE_UPDATE', d => { gameState=d.gameState; renderGameUI(); });

  // FIX 2: server-synced timer
  socket.on('TIMER_START', d => startClientTimer(d.secs));

  socket.on('NIGHT_TURN',       d => onNightTurn(d));
  socket.on('WOLF_VOTE_UPDATE', d => updateWolfVoteUI(d));

  socket.on('SEER_ANSWER', d => {
    const txt = d.isEvil ? `ğŸº ${d.targetName} lÃ  MA SÃ“I!` : `âœ… ${d.targetName} lÃ  DÃ‚N LÃ€NG (khÃ´ng pháº£i sÃ³i).`;
    $('seer-result-text').textContent = txt;
    $('seer-result-text').className = 'seer-result '+(d.isEvil?'evil':'good');
    openModal('seer-result-modal');
    appendLog('ğŸ”® '+txt, d.isEvil?'wolf':'day');
  });

  socket.on('YOU_DIED', d => {
    const reasons={ wolf:'Báº¡n bá»‹ Ma SÃ³i Äƒn thá»‹t trong Ä‘Ãªm.', vote:'LÃ ng Ä‘Ã£ treo cá»• báº¡n.', witch:'Báº¡n bá»‹ PhÃ¹ Thá»§y Ä‘áº§u Ä‘á»™c.', hunter:'Báº¡n bá»‹ Thá»£ SÄƒn báº¯n.', night:'Báº¡n Ä‘Ã£ cháº¿t trong Ä‘Ãªm.' };
    $('death-reason').textContent = reasons[d.reason]||'Báº¡n Ä‘Ã£ bá»‹ loáº¡i!';
    const r=ROLES[d.role]; $('death-role').textContent = r ? `Vai cá»§a báº¡n: ${r.icon} ${r.name}` : '';
    openModal('death-modal');
  });
  socket.on('HUNTER_TURN', d => showHunterModal(d.targets));
  socket.on('LOG',      d => appendLog(d.msg, d.cls));
  socket.on('CHAT_MSG', d => appendLog(`ğŸ’¬ ${d.from}: ${d.msg}`, 'chat'));
  socket.on('GAME_OVER',d => showEndScreen(d));
}

// ----------------------------------------------------------------
//  LOBBY
// ----------------------------------------------------------------
function createRoom(){
  const name=$('inp-name').value.trim(); if(!name) return notify('HÃ£y nháº­p tÃªn!','err');
  myName=name; myAvatar=AVATARS[name.charCodeAt(0)%AVATARS.length];
  socket.emit('CREATE_ROOM',{name,avatar:myAvatar});
}
function joinRoom(){
  const name=$('inp-name').value.trim(), code=$('inp-code').value.trim().toUpperCase();
  if(!name) return notify('HÃ£y nháº­p tÃªn!','err');
  if(code.length!==6) return notify('MÃ£ phÃ²ng cáº§n Ä‘Ãºng 6 kÃ½ tá»±!','err');
  myName=name; myAvatar=AVATARS[name.charCodeAt(0)%AVATARS.length];
  socket.emit('JOIN_ROOM',{code,name,avatar:myAvatar});
}
function leaveRoom(){ socket.disconnect(); socket.connect(); gameState=null; myRole=null; isHost=false; clearTimerUI(); showScreen('lobby'); }
function leaveGame(){ if(confirm('Báº¡n cÃ³ cháº¯c muá»‘n thoÃ¡t?')) leaveRoom(); }
function copyCode(){
  if(navigator.clipboard) navigator.clipboard.writeText(currentCode).catch(()=>{});
  notify('ÄÃ£ sao chÃ©p: '+currentCode,'ok');
}

// ----------------------------------------------------------------
//  ROOM UI
// ----------------------------------------------------------------
function updateRoomUI(room){
  $('room-code').textContent=room.code;
  $('room-pc').textContent=room.players.length+' ngÆ°á»i';
  $('room-grid').innerHTML=room.players.map(p=>`
    <div class="pcard ${p.id===room.hostId?'host':''} ${p.id===myId?'me':''}">
      <div class="pavatar">${p.avatar}</div>
      <div class="pname">${escH(p.name)}</div>
      <div class="pbadge">${p.id===room.hostId?'ğŸ‘‘ Chá»§ phÃ²ng':p.id===myId?'(Báº¡n)':'âœ¦'}</div>
    </div>`).join('');
  if(isHost){
    $('room-wait').textContent='Chia sáº» mÃ£ phÃ²ng cho báº¡n bÃ¨!';
    $('cfg-panel').style.display='';
    updateStartBtn(room.players.length);
  } else {
    $('room-wait').textContent='Chá» chá»§ phÃ²ng báº¯t Ä‘áº§u...';
    $('cfg-panel').style.display='none';
  }
}

function setupConfig(){
  const c=$('cfg-roles');
  c.innerHTML=ROLE_ORDER.filter(r=>r!=='villager').map(rid=>{
    const r=ROLES[rid];
    return `<div class="role-item" data-rid="${rid}">
      <span class="rname">${r.icon} ${r.name} <span style="font-size:9px;opacity:.35;">â“˜</span></span>
      <div class="rcnt">
        <button class="cbtn" data-adj="${rid}:-1">âˆ’</button>
        <span id="rc-${rid}">${roleConfig[rid]||0}</span>
        <button class="cbtn" data-adj="${rid}:1">+</button>
      </div>
    </div>`;
  }).join('');
  c.addEventListener('click', e=>{
    const adj=e.target.dataset.adj;
    if(adj){ const [r,d]=adj.split(':'); e.stopPropagation(); adjRole(r,+d); return; }
    const item=e.target.closest('[data-rid]');
    if(item) showRoleModal(item.dataset.rid);
  });
}

function adjRole(rid,d){
  if(!isHost) return;
  let v=(roleConfig[rid]||0)+d;
  if(rid==='wolf'&&v<1) return;
  roleConfig[rid]=Math.max(0,v);
  const el=$('rc-'+rid); if(el) el.textContent=roleConfig[rid];
  const np=parseInt($('room-pc').textContent)||0;
  updateStartBtn(np);
}

function updateStartBtn(np){
  const special=ROLE_ORDER.filter(r=>r!=='villager').reduce((s,r)=>s+(roleConfig[r]||0),0);
  const w=roleConfig.wolf||0, btn=$('start-btn'), msg=$('start-msg'); if(!btn) return;
  if(np<Math.max(4,w+2)){ btn.disabled=true; btn.textContent='ğŸŒ™ Cáº§n thÃªm ngÆ°á»i'; msg.textContent=`Cáº§n Ã­t nháº¥t ${Math.max(4,w+2)} ngÆ°á»i.`; }
  else if(special>np){ btn.disabled=true; btn.textContent='âš  QuÃ¡ nhiá»u vai'; msg.textContent='Giáº£m sá»‘ vai Ä‘áº·c biá»‡t xuá»‘ng.'; }
  else{ btn.disabled=false; btn.textContent='ğŸŒ™ Báº¯t Ä‘áº§u Game'; msg.textContent=`${np} ngÆ°á»i Â· ${w} sÃ³i Â· ${np-special} dÃ¢n lÃ ng`; }
}

function startGame(){
  if(!isHost) return;
  socket.emit('START_GAME',{code:currentCode,roleConfig,discussTime:parseInt($('discuss-time-select').value)||60});
}

// ----------------------------------------------------------------
//  FIX 3: Role info column
// ----------------------------------------------------------------
function renderRoleInfoCol(){
  const c=$('role-info-list'); if(!c) return;
  const cfg=gameState?.roleConfig; if(!cfg){ c.innerHTML=''; return; }
  c.innerHTML=ROLE_ORDER.map(rid=>{
    const cnt=cfg[rid]||0; if(!cnt) return '';
    const r=ROLES[rid];
    return `<div class="ri-chip" data-rid="${rid}">
      <span class="ri-icon">${r.icon}</span>
      <div class="ri-info">
        <div class="ri-name">${r.name}</div>
        <div class="ri-cnt">SL: <b>${cnt}</b></div>
      </div>
    </div>`;
  }).join('');
  // Safe click delegation
  c.addEventListener('click', e=>{
    const chip=e.target.closest('[data-rid]');
    if(chip) showRoleModal(chip.dataset.rid);
  });
}

// ----------------------------------------------------------------
//  GAME RENDER
// ----------------------------------------------------------------
function renderGameUI(){
  if(!gameState) return;
  const alive=gameState.players.filter(p=>p.alive);
  const dead=gameState.players.filter(p=>!p.alive);
  $('alive-cnt').textContent=alive.length; $('dead-cnt').textContent=dead.length;
  renderPlayerList('alive-list',alive,false);
  renderPlayerList('dead-list',dead,true);
  renderActionPanel();
}

function renderPlayerList(cid,players,isDead){
  const c=$(cid); if(!c) return;
  const me=gameState.players.find(p=>p.id===myId);
  const amAlive=me&&me.alive, phase=gameState.phase;
  // FIX 4: data-pid attribute, NO inline onclick in innerHTML
  c.innerHTML=players.map(p=>{
    const vc=(p.votes>0&&!isDead)?`<span class="vcnt">${p.votes}</span>`:'';
    const meTag=p.id===myId?' <span class="tag-me">Báº¡n</span>':'';
    const roleStr=(p.id===myId&&myRole&&ROLES[myRole])?`${ROLES[myRole].icon} ${ROLES[myRole].name}`:'';
    const roleDiv=roleStr?`<div class="gp-role">${roleStr}</div>`:`<div class="gp-role" style="opacity:.18">â€” áº©n â€”</div>`;
    const can=amAlive&&!isDead&&p.id!==myId&&phase==='vote';
    return `<div class="gp ${isDead?'dead':''} ${can?'can-target':''}" ${can?`data-pid="${p.id}"`:''} id="gpc-${p.id}">
      ${vc}<div class="gp-av">${p.avatar}</div>
      <div class="gp-name">${escH(p.name)}${meTag}</div>${roleDiv}
    </div>`;
  }).join('');
}

function renderMyRole(){
  if(!myRole) return; const r=ROLES[myRole]; if(!r) return;
  $('my-role-icon').textContent=r.icon; $('my-role-name').textContent=r.name;
  $('my-role-team').textContent='Phe: '+(r.team==='village'?'DÃ¢n LÃ ng':r.team==='wolf'?'Ma SÃ³i':'Trung Láº­p');
  $('my-role-team').style.color=TC[r.team]||'#CCC';
  $('my-role-ability').textContent=r.ability;
}

function renderActionPanel(){
  const p=$('action-content'); if(!p) return;
  const me=gameState?.players.find(x=>x.id===myId);
  if(!me||!me.alive){ p.innerHTML='<span class="dim-text">Báº¡n Ä‘ang quan sÃ¡t...</span>'; return; }
  const phase=gameState.phase;
  if(phase==='day'){ p.innerHTML='<span class="dim-text">Tháº£o luáº­n Ä‘á»ƒ tÃ¬m Ma SÃ³i!</span>'; }
  else if(phase==='vote'){
    const alive=gameState.players.filter(x=>x.alive).length, needed=Math.floor(alive/2)+1;
    const vname=gameState.votes?.[myId]?(gameState.players.find(x=>x.id===gameState.votes[myId])?.name||''):'';
    p.innerHTML=`<div class="majority-indicator">Cáº§n â‰¥ ${needed}/${alive} phiáº¿u</div>`
      +(vname?`<span class="dim-text">Phiáº¿u: <strong style="color:var(--crimson)">${escH(vname)}</strong></span>`
             :'<span class="dim-text">Báº¥m vÃ o tÃªn ngÆ°á»i Ä‘á»ƒ bá» phiáº¿u.</span>');
  } else if(phase==='night'){
    const cur=gameState.currentNightRole;
    const eff=(myRole==='cursed'&&gameState.cursedTurned?.includes(myId))?'wolf':myRole;
    const mine=eff===cur||(eff==='wolf'&&cur==='wolf');
    const lbl={wolf:'ğŸº Ma SÃ³i Ä‘ang thá»©c...',vampire:'ğŸ§› Ma CÃ  Rá»“ng Ä‘ang thá»©c...',guard:'ğŸ›¡ï¸ Báº£o Vá»‡ Ä‘ang thá»©c...',seer:'ğŸ”® TiÃªn Tri Ä‘ang thá»©c...',witch:'ğŸ§™â€â™€ï¸ PhÃ¹ Thá»§y Ä‘ang thá»©c...'};
    p.innerHTML=mine?'<span class="dim-text" style="color:var(--gold);font-weight:700;">âœ¨ Äáº¿n lÆ°á»£t báº¡n hÃ nh Ä‘á»™ng!</span>'
                    :`<span class="dim-text">${lbl[cur]||'Äang chá»...'}</span>`;
  }
}

function renderPhase(phase){
  const map={night:{icon:'ğŸŒ™',title:'MÃ n ÄÃªm',sub:'CÃ¡c vai Ä‘áº·c biá»‡t Ä‘ang hÃ nh Ä‘á»™ng...',cls:'night'},
             day:{icon:'â˜€ï¸',title:'Ban NgÃ y',sub:'Tháº£o luáº­n Ä‘á»ƒ tÃ¬m ra káº» Ä‘á»‹ch!',cls:'day'},
             vote:{icon:'âš–',title:'Bá» Phiáº¿u',sub:'Báº¥m vÃ o ngÆ°á»i Ä‘á»ƒ bá» phiáº¿u!',cls:'vote'}};
  const m=map[phase]||map.day;
  $('phase-icon').textContent=m.icon; $('phase-title').textContent=m.title;
  $('phase-sub').textContent=m.sub; $('phase-banner').className='phase-banner '+m.cls;
  document.body.className=phase==='night'?'night-bg':'';
}

// ----------------------------------------------------------------
//  FIX 1+2: SVG Ring Timer
// ----------------------------------------------------------------
function startClientTimer(secs){
  clearTimerUI();
  timerTotal=secs; timerEnd=Date.now()+secs*1000;
  const bar=$('trf'), num=$('timer-num');
  if(bar){ bar.style.strokeDasharray=RING_C; bar.style.strokeDashoffset=0; }
  timerIV=setInterval(()=>{
    const rem=Math.max(0,(timerEnd-Date.now())/1000);
    const remR=Math.ceil(rem), warn=remR<=10;
    const offset=RING_C*(1-rem/timerTotal);
    if(bar){ bar.style.strokeDashoffset=offset; bar.className='trf'+(warn?' warn':''); }
    if(num){ num.textContent=remR<=0?'â€”':remR+'s'; num.className='timer-num'+(warn?' warn':''); }
    if(remR<=0) clearTimerUI();
  },200);
}
function clearTimerUI(){
  if(timerIV){ clearInterval(timerIV); timerIV=null; }
  const bar=$('trf'), num=$('timer-num');
  if(bar){ bar.style.strokeDashoffset=RING_C; bar.className='trf'; }
  if(num){ num.textContent='â€”'; num.className='timer-num'; }
}

// ----------------------------------------------------------------
//  VOTE
// ----------------------------------------------------------------
function castVote(targetId){
  if(!gameState||gameState.phase!=='vote') return;
  const me=gameState.players.find(p=>p.id===myId); if(!me||!me.alive) return;
  const tgt=gameState.players.find(p=>p.id===targetId);
  $('vote-confirm-name').textContent=tgt?.name||'';
  pendingVoteTarget=targetId; openModal('vote-modal');
}
function confirmVote(){
  if(!pendingVoteTarget) return;
  socket.emit('VOTE_CAST',{code:currentCode,target:pendingVoteTarget});
  closeModal('vote-modal'); pendingVoteTarget=null;
}

// ----------------------------------------------------------------
//  NIGHT TURN HELPERS
// ----------------------------------------------------------------
let wolfSel=null, seerSel=null, vampireSel=null, guardSel=null;

function makeTargetBtns(containerId, targets, onSel, disabledIds=[]){
  const c=$(containerId); if(!c) return; c.innerHTML='';
  targets.forEach(t=>{
    const b=document.createElement('button'); b.className='target-btn';
    b.textContent=`${t.avatar||''} ${t.name}`;
    if(disabledIds.includes(t.id)){ b.disabled=true; b.style.opacity='.35'; b.textContent+=' (Ä‘Ãªm trÆ°á»›c)'; }
    else b.addEventListener('click',()=>{ c.querySelectorAll('.target-btn').forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); onSel(t.id); });
    c.appendChild(b);
  });
}

function onNightTurn(d){
  if(d.role==='wolf') showWolfModal(d);
  else if(d.role==='seer') showSeerModal(d);
  else if(d.role==='witch') showWitchModal(d);
  else if(d.role==='guard') showGuardModal(d);
  else if(d.role==='vampire') showVampireModal(d);
}

function showWolfModal(d){
  wolfSel=null; $('wolf-pack-info').textContent='ğŸº Báº§y sÃ³i: '+d.pack;
  $('wolf-confirm-btn').disabled=true;
  $('wolf-vote-status').innerHTML='<span style="opacity:.45;font-size:12px">ChÆ°a ai chá»n...</span>';
  $('wolf-consensus-label').textContent='';
  makeTargetBtns('wolf-targets',d.targets,id=>{ wolfSel=id; $('wolf-confirm-btn').disabled=false; socket.emit('NIGHT_ACT',{code:currentCode,type:'wolf',target:id}); });
  openModal('wolf-modal');
}
function wolfConfirm(){ if(wolfSel){ socket.emit('NIGHT_ACT',{code:currentCode,type:'wolf',target:wolfSel}); closeModal('wolf-modal'); } }
function updateWolfVoteUI(d){
  const c=$('wolf-vote-status'); if(!c) return;
  const lines=Object.entries(d.votes||{}).map(([wid,tid])=>{
    const wp=gameState?.players.find(p=>p.id===wid), tp=gameState?.players.find(p=>p.id===tid);
    if(!wp||!tp) return '';
    return `<div style="font-size:12px;color:#FFA0A0">${wp.name}${wid===myId?' (báº¡n)':''} â†’ ${tp.name}</div>`;
  }).filter(Boolean).join('');
  c.innerHTML=lines||'<span style="opacity:.45;font-size:12px">ChÆ°a ai chá»n...</span>';
  const lbl=$('wolf-consensus-label'), tp=d.wolfTarget?gameState?.players.find(p=>p.id===d.wolfTarget):null;
  if(lbl) lbl.textContent=tp?`âœ… Äá»“ng thuáº­n: ${tp.name}`:'';
}

function showSeerModal(d){
  seerSel=null; $('seer-confirm-btn').disabled=true;
  makeTargetBtns('seer-targets',d.targets,id=>{ seerSel=id; $('seer-confirm-btn').disabled=false; });
  openModal('seer-modal');
}
function seerConfirm(){ if(seerSel){ socket.emit('NIGHT_ACT',{code:currentCode,type:'seer',target:seerSel}); closeModal('seer-modal'); } }

function showWitchModal(d){
  const used=d.witchPotionUsed;
  $('witch-attacked-info').textContent=d.wasAttacked?'ğŸ©¸ SÃ³i Ä‘Ãªm nay Ä‘Ã£ táº¥n cÃ´ng ai Ä‘Ã³.':'âœ¨ SÃ³i khÃ´ng táº¥n cÃ´ng Ä‘Ãªm nay.';
  $('witch-save-btn').disabled=used||!d.wasAttacked;
  $('witch-save-btn').textContent=used?'ğŸ’Š ÄÃ£ dÃ¹ng bÃ¬nh thuá»‘c':d.wasAttacked?'ğŸ’Š Cá»©u ngÆ°á»i bá»‹ táº¥n cÃ´ng':'ğŸ’Š KhÃ´ng cÃ³ ai Ä‘á»ƒ cá»©u';
  $('witch-kill-open-btn').disabled=used;
  $('witch-kill-open-btn').textContent=used?'â˜  ÄÃ£ dÃ¹ng bÃ¬nh thuá»‘c':'â˜  DÃ¹ng bÃ¬nh Ä‘á»™c (giáº¿t ngÆ°á»i)';
  window._wkTargets=d.killTargets||[];
  openModal('witch-modal');
}
function doWitchSave(){ socket.emit('WITCH_SAVE',{code:currentCode}); closeModal('witch-modal'); appendLog('ğŸ§™â€â™€ï¸ Báº¡n Ä‘Ã£ dÃ¹ng bÃ¬nh cá»©u ngÆ°á»i.','night'); }
function showWitchKillModal(){
  closeModal('witch-modal');
  let sel=null; $('witch-kill-confirm').disabled=true;
  makeTargetBtns('witch-kill-targets',window._wkTargets||[],id=>{ sel=id; $('witch-kill-confirm').disabled=false; });
  $('witch-kill-confirm').onclick=()=>{ if(!sel) return; socket.emit('WITCH_KILL',{code:currentCode,target:sel}); closeModal('witch-kill-modal'); appendLog('ğŸ§™â€â™€ï¸ Báº¡n Ä‘Ã£ dÃ¹ng bÃ¬nh Ä‘á»™c.','night'); };
  openModal('witch-kill-modal');
}

function showGuardModal(d){
  guardSel=null; $('guard-confirm-btn').disabled=true;
  makeTargetBtns('guard-targets',d.targets,id=>{ guardSel=id; $('guard-confirm-btn').disabled=false; }, d.lastProtected?[d.lastProtected]:[]);
  openModal('guard-modal');
}
function guardConfirm(){ if(guardSel){ socket.emit('GUARD_ACT',{code:currentCode,target:guardSel}); closeModal('guard-modal'); appendLog('ğŸ›¡ï¸ Báº¡n Ä‘Ã£ chá»n ngÆ°á»i báº£o vá»‡.','night'); } }

function showVampireModal(d){
  vampireSel=null; $('vamp-confirm-btn').disabled=true;
  makeTargetBtns('vamp-targets',d.targets,id=>{ vampireSel=id; $('vamp-confirm-btn').disabled=false; });
  openModal('vamp-modal');
}
function vampireConfirm(){ if(vampireSel){ socket.emit('NIGHT_ACT',{code:currentCode,type:'vampire',target:vampireSel}); closeModal('vamp-modal'); } }

// ----------------------------------------------------------------
//  HUNTER
// ----------------------------------------------------------------
let _hunterIV=null, _hunterSel=null;
function showHunterModal(targets){
  _hunterSel=null; $('hunter-fire-btn').disabled=true;
  makeTargetBtns('hunter-targets',targets,id=>{ _hunterSel=id; $('hunter-fire-btn').disabled=false; });
  $('hunter-fire-btn').onclick=()=>{ if(!_hunterSel) return; socket.emit('HUNTER_SHOT',{code:currentCode,target:_hunterSel}); clearInterval(_hunterIV); closeModal('hunter-modal'); };
  openModal('hunter-modal');
  let rem=10; const td=$('hunter-timer-display'); if(td) td.textContent=rem;
  _hunterIV=setInterval(()=>{ rem--; if(td) td.textContent=rem; if(rem<=0){ clearInterval(_hunterIV); closeModal('hunter-modal'); } },1000);
}
function hunterFire(){} // handled by onclick in showHunterModal

// ----------------------------------------------------------------
//  CHAT
// ----------------------------------------------------------------
function sendChat(){
  const inp=$('chat-inp'), msg=inp.value.trim(); if(!msg) return;
  inp.value='';
  socket.emit('CHAT',{code:currentCode,msg}); // server echoes back to all â€” no local log
}

// ----------------------------------------------------------------
//  ROLE MODAL
// ----------------------------------------------------------------
function showRoleModal(rid){
  const r=ROLES[rid]; if(!r) return;
  $('reveal-icon').textContent=r.icon; $('reveal-name').textContent=r.name;
  $('reveal-desc').textContent=r.desc; $('reveal-ability').textContent='âš¡ '+r.ability;
  $('reveal-team').textContent='Phe: '+(TN[r.team]||r.team); $('reveal-team').style.color=TC[r.team]||'#CCC';
  openModal('role-modal');
}

// ----------------------------------------------------------------
//  END SCREEN
// ----------------------------------------------------------------
function showEndScreen(d){
  clearTimerUI();
  const t={village:'ğŸ†',wolf:'ğŸº',vampire:'ğŸ§›',bored:'ğŸ˜‘'};
  $('end-trophy').textContent=t[d.winner]||'ğŸ†'; $('end-title').textContent=d.msg||'TrÃ² chÆ¡i káº¿t thÃºc!';
  $('end-winners').innerHTML=(d.names||[]).map(n=>`<span class="winner-chip">${escH(n)}</span>`).join('');
  const rp=$('end-roles');
  if(d.allPlayers&&rp) rp.innerHTML=d.allPlayers.map(p=>{ const r=ROLES[p.role]; return `<div class="end-player ${p.alive?'':'dead'}"><span>${p.avatar}</span><span style="flex:1">${escH(p.name)}</span><span>${r?r.icon+' '+r.name:''}</span></div>`; }).join('');
  showScreen('end');
}
function returnToLobby(){ gameState=null; myRole=null; clearTimerUI(); showScreen('lobby'); }

// ----------------------------------------------------------------
//  UTILS
// ----------------------------------------------------------------
function appendLog(msg,cls='sys'){
  const c=$('log-msgs'); if(!c) return;
  const d=document.createElement('div'); d.className='log-line '+cls; d.textContent=msg;
  c.appendChild(d); c.scrollTop=c.scrollHeight;
}
function clearLog(){ const c=$('log-msgs'); if(c) c.innerHTML=''; }
function showScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); const s=$('scr-'+id); if(s) s.classList.add('active'); }
function openModal(id){ const m=$(id); if(m) m.style.display='flex'; }
function closeModal(id){ const m=$(id); if(m) m.style.display='none'; }
let _notifTO=null;
function notify(msg,type=''){
  const el=$('notif'); if(!el) return;
  el.textContent=msg; el.className='notif show'+(type==='err'?' error':type==='ok'?' success':'');
  if(_notifTO) clearTimeout(_notifTO);
  _notifTO=setTimeout(()=>el.classList.remove('show'),3200);
}
</script>
</body>
</html>
