<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0a14">
<title>üê∫ Ma S√≥i Online</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0a14;--panel:#12121f;--border:rgba(255,255,255,.08);
  --gold:#C8973A;--silver:#B0B8C8;--moon:#E8DCC8;
  --crimson:#DC143C;--night:#1a1430;--wolf:#8B0000;
  --day:#2a2010;--vote:#1a0a20;
  --font-body:'Be Vietnam Pro',sans-serif;
  --font-title:'Cinzel',serif;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);color:var(--moon);font-family:var(--font-body);min-height:100vh;overflow-x:hidden;}
body.night-bg{background:var(--night);}

/* ---- SCREENS ---- */
.screen{display:none;min-height:100vh;}
.screen.active{display:flex;flex-direction:column;align-items:center;}

/* ---- LOBBY ---- */
#scr-lobby{justify-content:center;padding:20px;background:radial-gradient(ellipse at 50% 20%,rgba(200,151,58,.12) 0%,transparent 60%),var(--bg);}
.moon-svg{width:100px;height:100px;margin-bottom:10px;filter:drop-shadow(0 0 20px rgba(200,151,58,.4));}
.title{font-size:clamp(36px,8vw,56px);letter-spacing:.3em;color:var(--gold);font-family:var(--font-title);text-shadow:0 0 30px rgba(200,151,58,.5);}
.subtitle{font-size:13px;color:var(--silver);letter-spacing:.2em;margin-bottom:28px;font-family:var(--font-body);}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:28px 24px;width:100%;max-width:420px;}
.card h2{font-size:16px;color:var(--gold);letter-spacing:.1em;margin-bottom:20px;text-align:center;font-family:var(--font-title);}
.ig{margin-bottom:14px;}
.lbl{display:block;font-size:11px;color:var(--silver);letter-spacing:.1em;margin-bottom:6px;}
.inp{width:100%;background:rgba(0,0,0,.4);border:1px solid var(--border);border-radius:8px;padding:12px 14px;color:var(--moon);font-size:16px;outline:none;transition:border .2s;}
.inp:focus{border-color:rgba(200,151,58,.5);}
.inp-code{text-transform:uppercase;letter-spacing:.3em;text-align:center;font-size:20px;font-weight:700;}
.btn-p{width:100%;background:linear-gradient(135deg,#8B0000,#C41E3A);border:none;border-radius:10px;padding:14px;color:var(--moon);font-size:15px;font-family:var(--font-body);letter-spacing:.03em;cursor:pointer;transition:all .25s;margin-bottom:10px;font-weight:600;}
.btn-p:hover{opacity:.9;transform:translateY(-1px);}
.btn-p:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.btn-s{width:100%;background:rgba(200,151,58,.12);border:1px solid rgba(200,151,58,.3);border-radius:10px;padding:12px;color:var(--gold);font-size:14px;font-family:var(--font-body);cursor:pointer;transition:all .25s;margin-bottom:10px;font-weight:500;}
.btn-s:hover{background:rgba(200,151,58,.2);}
.divider{text-align:center;color:var(--silver);font-size:12px;margin:10px 0;position:relative;}
.divider::before,.divider::after{content:'';position:absolute;top:50%;width:38%;height:1px;background:var(--border);}
.divider::before{left:0;} .divider::after{right:0;}
.hint{font-size:11px;color:var(--silver);text-align:center;margin-top:20px;max-width:360px;line-height:1.7;opacity:.7;}

/* ---- ROOM ---- */
#scr-room{justify-content:flex-start;padding:0;}
.room-hd{width:100%;display:flex;justify-content:space-between;align-items:center;padding:16px 18px;background:rgba(0,0,0,.4);border-bottom:1px solid var(--border);}
.code-box{display:flex;flex-direction:column;}
.code-lbl{font-size:10px;color:var(--silver);letter-spacing:.1em;}
.code-val{font-size:22px;letter-spacing:.3em;color:var(--gold);font-weight:700;cursor:pointer;}
.btn-sm{padding:7px 14px;font-size:12px;border-radius:7px;white-space:nowrap;}
.room-body{display:flex;flex-wrap:wrap;gap:16px;padding:16px;width:100%;max-width:900px;}
.players-area{flex:1;min-width:220px;}
.players-area h2{font-size:14px;color:var(--silver);letter-spacing:.1em;margin-bottom:12px;}
.pgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;}
.pcard{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:12px 8px;text-align:center;transition:border .2s;}
.pcard.host{border-color:rgba(200,151,58,.5);}
.pcard.me{border-color:rgba(100,180,255,.4);}
.pavatar{font-size:28px;margin-bottom:4px;}
.pname{font-size:12px;color:var(--moon);word-break:break-all;}
.pbadge{font-size:10px;color:var(--silver);margin-top:3px;}
.cfg-panel{flex:1;min-width:220px;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:18px;}
.cfg-panel h3{font-size:13px;color:var(--gold);letter-spacing:.1em;margin-bottom:14px;}
.role-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;margin-bottom:6px;border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:background .2s;}
.role-item:hover{background:rgba(200,151,58,.08);}
.rname{font-size:13px;color:var(--moon);}
.rcnt{display:flex;align-items:center;gap:10px;}
.cbtn{background:rgba(255,255,255,.08);border:1px solid var(--border);border-radius:5px;color:var(--moon);width:26px;height:26px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;}
.cbtn:hover{background:rgba(255,255,255,.15);}
.start-btn{width:100%;background:linear-gradient(135deg,#8B0000,#C41E3A);border:none;border-radius:10px;padding:14px;color:var(--moon);font-size:15px;font-family:var(--font-body);font-weight:600;cursor:pointer;margin-top:14px;transition:all .25s;}
.start-btn:disabled{opacity:.4;cursor:not-allowed;}
#start-msg{font-size:11px;color:var(--silver);text-align:center;margin-top:8px;}
.time-select{background:rgba(10,10,20,.85);border:1px solid rgba(200,151,58,.3);border-radius:6px;color:var(--gold);font-size:13px;font-family:var(--font-body);padding:4px 8px;cursor:pointer;outline:none;}
.time-select option{background:#1a1430;color:var(--moon);}

/* Role info column in game */
.role-info-col{width:160px;min-width:140px;border-left:1px solid var(--border);background:rgba(0,0,0,.15);padding:10px 8px;overflow-y:auto;}
@media(max-width:700px){.role-info-col{display:none;}}
.role-info-col h4{font-size:9px;color:var(--silver);letter-spacing:.2em;margin-bottom:8px;font-family:var(--font-body);}
.ri-row{display:flex;align-items:center;gap:6px;padding:5px 6px;margin-bottom:3px;border-radius:6px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.04);}
.ri-row-icon{font-size:16px;flex-shrink:0;}
.ri-row-info{flex:1;min-width:0;}
.ri-row-name{font-size:10px;color:var(--moon);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ri-row-cnt{font-size:9px;color:var(--silver);}
.ri-row-cnt span{color:var(--gold);font-weight:700;}

/* ---- GAME ---- */
#scr-game{justify-content:flex-start;align-items:stretch;padding:0;}
.game-wrap{display:flex;flex-direction:column;height:100vh;max-height:100vh;}
.phase-banner{display:flex;align-items:center;gap:12px;padding:12px 16px;transition:background .5s;}
.phase-banner.night{background:linear-gradient(90deg,rgba(26,10,40,.9),rgba(40,20,60,.9));}
.phase-banner.day{background:linear-gradient(90deg,rgba(42,32,16,.9),rgba(60,44,20,.9));}
.phase-banner.vote{background:linear-gradient(90deg,rgba(26,10,20,.9),rgba(60,20,30,.9));}
.ph-icon{font-size:28px;}
.ph-info{flex:1;}
.ph-title{font-size:16px;font-weight:700;color:var(--gold);font-family:var(--font-title);}
.ph-sub{font-size:11px;color:var(--silver);font-family:var(--font-body);}
.timer{font-size:20px;font-weight:900;color:var(--gold);font-family:monospace;min-width:40px;text-align:right;}
.timer.warn{color:var(--crimson);animation:pulse .5s ease infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.5;}}
.exit-btn{background:rgba(139,0,0,.25);border:1px solid rgba(220,20,60,.3);color:var(--crimson);border-radius:6px;padding:5px 10px;cursor:pointer;font-size:14px;font-weight:700;}
.game-grid{display:flex;flex:1;overflow:hidden;gap:0;}
.stage{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:10px;}
.section-hd{font-size:10px;color:var(--silver);letter-spacing:.15em;margin-bottom:6px;padding:0 2px;}
.gp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(82px,1fr));gap:6px;}
.gp{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px 6px;text-align:center;position:relative;transition:all .2s;}
.gp.can-target{cursor:pointer;border-color:rgba(220,20,60,.3);}
.gp.can-target:hover{border-color:var(--crimson);background:rgba(220,20,60,.08);transform:translateY(-2px);}
.gp.dead{opacity:.4;filter:grayscale(.7);}
.gp-av{font-size:22px;margin-bottom:3px;}
.gp-name{font-size:11px;color:var(--moon);word-break:break-all;}
.gp-role{font-size:10px;color:var(--silver);margin-top:3px;opacity:.6;}
.vcnt{position:absolute;top:-6px;right:-6px;background:var(--crimson);color:#fff;border-radius:50%;width:20px;height:20px;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;}
.tag-me{font-size:9px;color:#64B4FF;background:rgba(100,180,255,.15);border-radius:3px;padding:1px 4px;margin-left:3px;}
.dead-sec{margin-top:8px;opacity:.7;}
.sidebar{width:220px;min-width:180px;display:flex;flex-direction:column;border-left:1px solid var(--border);background:rgba(0,0,0,.2);}
@media(max-width:600px){.sidebar{width:100%;border-left:none;border-top:1px solid var(--border);max-height:280px;}}
.my-role-box,.action-box{padding:12px;border-bottom:1px solid var(--border);}
.my-role-box h4,.action-box h4,.log-box h4{font-size:9px;color:var(--silver);letter-spacing:.2em;margin-bottom:8px;}
.role-pill{display:flex;gap:10px;align-items:flex-start;}
.ri-icon{font-size:28px;}
.ri-name{font-size:13px;font-weight:700;color:var(--gold);font-family:Georgia,serif;}
.ri-team{font-size:10px;color:var(--silver);margin-top:2px;}
.ri-ability{font-size:10px;color:var(--silver);margin-top:4px;line-height:1.4;opacity:.8;}
.action-box{min-height:70px;}
.dim-text{font-size:12px;color:var(--silver);opacity:.6;}
.abtn{background:rgba(200,151,58,.15);border:1px solid rgba(200,151,58,.3);border-radius:7px;padding:8px 12px;color:var(--gold);font-size:12px;font-family:Georgia,serif;cursor:pointer;width:100%;margin-bottom:6px;transition:all .2s;}
.abtn:hover{background:rgba(200,151,58,.25);}
.abtn.danger{background:rgba(139,0,0,.2);border-color:rgba(220,20,60,.3);color:var(--crimson);}
.abtn:disabled{opacity:.35;cursor:not-allowed;}
.log-box{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:10px;}
.log-scroll{flex:1;overflow-y:auto;font-size:11px;line-height:1.7;}
.log-scroll::-webkit-scrollbar{width:4px;}
.log-scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.log-line{padding:2px 0;border-bottom:1px solid rgba(255,255,255,.04);}
.log-line.night{color:#8888FF;}
.log-line.death{color:var(--crimson);}
.log-line.day{color:#C8973A;}
.log-line.vote{color:#CC88FF;}
.log-line.win{color:#88FF88;font-weight:700;}
.log-line.chat{color:#64B4FF;}
.log-line.wolf{color:#FF6060;}
.game-bottom{display:flex;gap:8px;padding:10px;border-top:1px solid var(--border);background:rgba(0,0,0,.3);}
.chat-inp{flex:1;background:rgba(0,0,0,.4);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--moon);font-size:16px;font-family:var(--font-body);outline:none;}
.send-btn{background:rgba(200,151,58,.15);border:1px solid rgba(200,151,58,.3);border-radius:8px;padding:10px 16px;color:var(--gold);cursor:pointer;font-size:14px;font-family:var(--font-body);font-weight:600;white-space:nowrap;}
.majority-indicator{font-size:11px;color:var(--silver);text-align:center;padding:5px 10px;background:rgba(139,0,0,.15);border:1px solid rgba(220,20,60,.2);border-radius:6px;margin-bottom:8px;}

/* ---- END ---- */
#scr-end{justify-content:center;padding:24px;background:radial-gradient(ellipse at 50% 30%,rgba(200,151,58,.1) 0%,transparent 60%),var(--bg);}
.end-content{text-align:center;width:100%;max-width:500px;}
.end-trophy{font-size:80px;display:block;margin-bottom:12px;animation:trophyPop .6s ease;}
@keyframes trophyPop{0%{transform:scale(0);}80%{transform:scale(1.1);}100%{transform:scale(1);}}
.end-title{font-size:clamp(18px,4vw,26px);color:var(--gold);font-family:Georgia,serif;margin-bottom:16px;line-height:1.4;}
.end-winners{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-bottom:20px;}
.winner-chip{background:rgba(200,151,58,.2);border:1px solid rgba(200,151,58,.4);border-radius:20px;padding:6px 16px;font-size:13px;color:var(--gold);}
.end-roles{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:20px;text-align:left;}
.end-player{display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid rgba(255,255,255,.05);font-size:13px;}
.end-player:last-child{border-bottom:none;}
.end-player.dead{opacity:.5;}

/* ---- MODALS ---- */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:100;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(4px);}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:24px 20px;width:100%;max-width:460px;max-height:90vh;overflow-y:auto;}
.modal-icon{font-size:48px;display:block;text-align:center;margin-bottom:8px;}
.modal h2{font-size:18px;font-family:var(--font-title);color:var(--gold);text-align:center;margin-bottom:12px;}
.modal p{font-size:13px;color:var(--silver);line-height:1.7;margin-bottom:12px;text-align:center;font-family:var(--font-body);}
.modal-btns{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:14px;}
.mbtn{padding:11px 22px;border-radius:10px;font-size:14px;font-family:var(--font-body);font-weight:600;cursor:pointer;border:none;transition:all .2s;}
.mbtn.p{background:linear-gradient(135deg,#8B0000,#C41E3A);color:var(--moon);}
.mbtn.s{background:rgba(200,151,58,.15);border:1px solid rgba(200,151,58,.3);color:var(--gold);}
.mbtn:disabled{opacity:.35;cursor:not-allowed;}
.modal-team{text-align:center;font-size:12px;margin-bottom:10px;font-weight:700;}
.targets-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin:12px 0;max-height:280px;overflow-y:auto;}
.target-btn{background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:8px;padding:10px 8px;color:var(--moon);font-size:13px;cursor:pointer;transition:all .2s;text-align:center;}
.target-btn:hover{border-color:rgba(200,151,58,.5);background:rgba(200,151,58,.1);}
.target-btn.sel{border-color:var(--gold);background:rgba(200,151,58,.2);color:var(--gold);font-weight:700;}
.target-btn:disabled{opacity:.35;cursor:not-allowed;}
.wolf-pack{font-size:12px;color:#FF9090;text-align:center;margin-bottom:8px;}
.seer-result{font-size:16px;font-weight:700;text-align:center;padding:16px;border-radius:10px;margin:10px 0;}
.seer-result.good{background:rgba(50,150,50,.15);color:#88FF88;border:1px solid rgba(100,220,100,.3);}
.seer-result.evil{background:rgba(150,20,20,.2);color:#FF8888;border:1px solid rgba(220,60,60,.3);}

/* ---- NOTIFY ---- */
.notif{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:12px 20px;font-size:13px;color:var(--moon);transition:transform .3s ease;z-index:200;white-space:nowrap;max-width:90vw;}
.notif.show{transform:translateX(-50%) translateY(0);}
.notif.error{border-color:rgba(220,20,60,.5);color:var(--crimson);}
.notif.success{border-color:rgba(100,220,100,.4);color:#88FF88;}
</style>
</head>
<body>
<div id="app">

<!-- LOBBY -->
<div id="scr-lobby" class="screen active">
  <svg class="moon-svg" viewBox="0 0 100 100" fill="none">
    <path d="M50 10 C28 10,10 28,10 50 C10 72,28 90,50 90 C38 82,30 66,32 50 C34 36,44 24,56 20 C54 16,52 12,50 10Z" fill="rgba(232,220,200,0.9)"/>
    <circle cx="50" cy="50" r="42" stroke="rgba(232,220,200,0.15)" stroke-width="0.5" fill="none"/>
  </svg>
  <div class="title">MA S√ìI</div>
  <div class="subtitle">‚ú¶ Ch∆°i Online ‚ú¶</div>
  <div class="card">
    <h2>‚öî B∆∞·ªõc v√†o l√†ng</h2>
    <div class="ig"><label class="lbl">T√äN C·ª¶A B·∫†N</label><input id="inp-name" class="inp" placeholder="T√™n hi·ªÉn th·ªã..." maxlength="18" autocomplete="off"/></div>
    <button class="btn-p" onclick="createRoom()">üè† T·∫°o Ph√≤ng M·ªõi</button>
    <div class="divider">ho·∫∑c tham gia ph√≤ng c√≥ s·∫µn</div>
    <div class="ig"><label class="lbl">M√É PH√íNG</label><input id="inp-code" class="inp inp-code" placeholder="XXXXXX" maxlength="6" autocomplete="off"/></div>
    <button class="btn-s" onclick="joinRoom()">üö™ Tham Gia Ph√≤ng</button>
  </div>
  <div class="hint">üí° Chia s·∫ª m√£ ph√≤ng ƒë·ªÉ b·∫°n b√® tham gia t·ª´ b·∫•t k·ª≥ thi·∫øt b·ªã n√†o!</div>
</div>

<!-- ROOM -->
<div id="scr-room" class="screen">
  <div class="room-hd">
    <div class="code-box">
      <span class="code-lbl">M√É PH√íNG (nh·∫•n ƒë·ªÉ sao ch√©p)</span>
      <span id="room-code" class="code-val" onclick="copyCode()">------</span>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <span id="room-pc" style="font-size:12px;color:var(--silver)"></span>
      <button class="btn-s btn-sm" onclick="leaveRoom()">‚Üê R·ªùi</button>
    </div>
  </div>
  <div class="room-body">
    <div class="players-area">
      <h2>üë• NG∆Ø·ªúI CH∆†I</h2>
      <div id="room-grid" class="pgrid"></div>
      <div id="room-wait" style="font-size:12px;color:var(--silver);margin-top:10px;"></div>
    </div>
    <div id="cfg-panel" class="cfg-panel">
      <h3>‚öô C√†i ƒë·∫∑t vai tr√≤ <span style="font-size:10px;opacity:.5">(nh·∫•n t√™n ƒë·ªÉ xem)</span></h3>
      <div id="cfg-roles"></div>
      <div class="role-item" style="border-color:rgba(200,151,58,.2);">
        <span class="rname">‚è± Th·ªùi gian th·∫£o lu·∫≠n</span>
        <select id="discuss-time-select" class="time-select">
          <option value="60">1 ph√∫t</option>
          <option value="120">2 ph√∫t</option>
          <option value="180">3 ph√∫t</option>
          <option value="240">4 ph√∫t</option>
          <option value="300">5 ph√∫t</option>
        </select>
      </div>
      <button id="start-btn" class="start-btn" onclick="startGame()" disabled>üåô B·∫Øt ƒë·∫ßu</button>
      <div id="start-msg"></div>
    </div>
  </div>
</div>

<!-- GAME -->
<div id="scr-game" class="screen">
  <div class="game-wrap">
    <div id="phase-banner" class="phase-banner day">
      <span id="phase-icon" class="ph-icon">‚òÄÔ∏è</span>
      <div class="ph-info">
        <div id="phase-title" class="ph-title">Ban Ng√†y</div>
        <div id="phase-sub" class="ph-sub">Th·∫£o lu·∫≠n!</div>
      </div>
      <div id="timer" class="timer"></div>
      <button class="exit-btn" onclick="leaveGame()">‚úï</button>
    </div>
    <div class="game-grid">
      <div class="stage">
        <div>
          <div class="section-hd">C√íN S·ªêNG (<span id="alive-cnt">0</span>)</div>
          <div id="alive-list" class="gp-grid"></div>
        </div>
        <div class="dead-sec">
          <div class="section-hd">ƒê√É CH·∫æT (<span id="dead-cnt">0</span>)</div>
          <div id="dead-list" class="gp-grid"></div>
        </div>
      </div>
      <!-- Fix 4: Role info column -->
      <div class="role-info-col">
        <h4>üé≠ VAI TRONG GAME</h4>
        <div id="role-info-list"></div>
      </div>
      <div class="sidebar">
        <div class="my-role-box">
          <h4>VAI C·ª¶A B·∫†N</h4>
          <div class="role-pill">
            <span id="my-role-icon" class="ri-icon">‚ùì</span>
            <div>
              <div id="my-role-name" class="ri-name">Ch∆∞a r√µ</div>
              <div id="my-role-team" class="ri-team"></div>
              <div id="my-role-ability" class="ri-ability"></div>
            </div>
          </div>
        </div>
        <div class="action-box">
          <h4>H√ÄNH ƒê·ªòNG</h4>
          <div id="action-content"></div>
        </div>
        <div class="log-box">
          <h4>üìú NH·∫¨T K√ù</h4>
          <div id="log-msgs" class="log-scroll"></div>
        </div>
      </div>
    </div>
    <div class="game-bottom">
      <input id="chat-inp" class="chat-inp" placeholder="Nh·∫Øn tin v·ªõi l√†ng..." maxlength="120" autocomplete="off"/>
      <button class="send-btn" onclick="sendChat()">G·ª≠i ‚Üí</button>
    </div>
  </div>
</div>

<!-- END -->
<div id="scr-end" class="screen">
  <div class="end-content">
    <span id="end-trophy" class="end-trophy">üèÜ</span>
    <div id="end-title" class="end-title"></div>
    <div id="end-winners" class="end-winners"></div>
    <div id="end-roles" class="end-roles"></div>
    <button class="btn-p" style="max-width:260px;margin:0 auto;display:block" onclick="returnToLobby()">üè† V·ªÅ s·∫£nh ch·ªù</button>
  </div>
</div>
</div><!-- #app -->

<!-- MODALS -->
<div id="role-modal" class="modal-bg">
  <div class="modal">
    <span id="reveal-icon" class="modal-icon">üé≠</span>
    <h2 id="reveal-name"></h2>
    <div id="reveal-team" class="modal-team"></div>
    <p id="reveal-desc"></p>
    <div class="modal-btns"><button class="mbtn p" onclick="closeModal('role-modal')">T√¥i ƒë√£ hi·ªÉu ‚úì</button></div>
  </div>
</div>

<div id="death-modal" class="modal-bg">
  <div class="modal">
    <span class="modal-icon">üíÄ</span>
    <h2>B·∫°n ƒë√£ b·ªã lo·∫°i!</h2>
    <p id="death-reason"></p>
    <p id="death-role" style="color:var(--gold);font-size:14px;"></p>
    <div class="modal-btns"><button class="mbtn s" onclick="closeModal('death-modal')">Ti·∫øp t·ª•c xem</button></div>
  </div>
</div>

<div id="vote-modal" class="modal-bg">
  <div class="modal">
    <span class="modal-icon">‚öñ</span>
    <h2>X√°c nh·∫≠n b·ªè phi·∫øu</h2>
    <p>B·∫°n mu·ªën treo c·ªï <strong id="vote-confirm-name" style="color:var(--crimson)"></strong>?</p>
    <div class="modal-btns">
      <button class="mbtn p" onclick="confirmVote()">‚úì X√°c nh·∫≠n</button>
      <button class="mbtn s" onclick="closeModal('vote-modal')">‚úó H·ªßy</button>
    </div>
  </div>
</div>

<div id="wolf-modal" class="modal-bg">
  <div class="modal" style="max-width:500px">
    <span class="modal-icon">üê∫</span>
    <h2>Ma S√≥i th·ª©c d·∫≠y!</h2>
    <div id="wolf-pack-info" class="wolf-pack"></div>
    <p style="margin-bottom:6px">Ch·ªçn n·∫°n nh√¢n (c·∫ßn ƒëa s·ªë b·∫ßy ƒë·ªìng √Ω):</p>
    <div id="wolf-targets" class="targets-grid"></div>
    <div style="margin:10px 0;padding:10px;background:rgba(139,0,0,.2);border-radius:8px;border:1px solid rgba(220,20,60,.2)">
      <div style="font-size:10px;color:var(--silver);margin-bottom:4px;letter-spacing:.1em">PHI·∫æU C·ª¶A B·∫¶Y:</div>
      <div id="wolf-vote-status"><span style="opacity:.5;font-size:12px">Ch∆∞a ai ch·ªçn...</span></div>
      <div id="wolf-consensus-label" style="font-size:13px;color:#88FF88;margin-top:6px;font-weight:600;"></div>
    </div>
    <div class="modal-btns">
      <button id="wolf-confirm-btn" class="mbtn p" onclick="wolfConfirm()" disabled>üê∫ X√°c nh·∫≠n ch·ªçn!</button>
      <button class="mbtn s" onclick="closeModal('wolf-modal')">üò¥ B·ªè qua</button>
    </div>
  </div>
</div>

<div id="seer-modal" class="modal-bg">
  <div class="modal">
    <span class="modal-icon">üîÆ</span>
    <h2>Ti√™n Tri th·ª©c d·∫≠y!</h2>
    <p>Ch·ªçn ng∆∞·ªùi ƒë·ªÉ xem b·∫£n ch·∫•t (ch·ªâ ph√°t hi·ªán Ma S√≥i):</p>
    <div id="seer-targets" class="targets-grid"></div>
    <div class="modal-btns"><button id="seer-confirm-btn" class="mbtn p" onclick="seerConfirm()" disabled>üîÆ Nh√¨n th·∫•u!</button></div>
  </div>
</div>

<div id="seer-result-modal" class="modal-bg">
  <div class="modal">
    <span class="modal-icon">üîÆ</span>
    <h2>Nh√£n Thi√™n L√Ω Th·∫•y...</h2>
    <div id="seer-result-text" class="seer-result good"></div>
    <div class="modal-btns"><button class="mbtn s" onclick="closeModal('seer-result-modal')">ƒê√£ hi·ªÉu</button></div>
  </div>
</div>

<div id="witch-modal" class="modal-bg">
  <div class="modal">
    <span class="modal-icon">üßô‚Äç‚ôÄÔ∏è</span>
    <h2>Ph√π Th·ªßy th·ª©c d·∫≠y!</h2>
    <p style="font-size:11px;color:#FFAA44;margin-bottom:8px;">‚ö† Ch·ªâ 1 b√¨nh cho c·∫£ game! D√πng ƒë·ªÉ c·ª©u HO·∫∂C gi·∫øt.</p>
    <p id="witch-attacked-info" style="font-weight:600;margin-bottom:14px;"></p>
    <div class="modal-btns" style="flex-direction:column;gap:8px;">
      <button id="witch-save-btn" class="mbtn p" onclick="doWitchSave()">üíä C·ª©u ng∆∞·ªùi b·ªã t·∫•n c√¥ng</button>
      <button id="witch-kill-open-btn" class="mbtn s" onclick="showWitchKillModal()">‚ò† D√πng b√¨nh ƒë·ªôc</button>
      <button class="mbtn s" onclick="closeModal('witch-modal')">üò¥ B·ªè qua ƒë√™m nay</button>
    </div>
  </div>
</div>

<div id="witch-kill-modal" class="modal-bg">
  <div class="modal">
    <span class="modal-icon">‚ò†</span>
    <h2>Ch·ªçn m·ª•c ti√™u ƒë·∫ßu ƒë·ªôc!</h2>
    <p style="color:#FFAA44;font-size:12px;">Sau khi d√πng, b√¨nh thu·ªëc m·∫•t vƒ©nh vi·ªÖn!</p>
    <div id="witch-kill-targets" class="targets-grid"></div>
    <div class="modal-btns">
      <button id="witch-kill-confirm" class="mbtn p" disabled>‚ò† ƒê·∫ßu ƒë·ªôc!</button>
      <button class="mbtn s" onclick="closeModal('witch-kill-modal');openModal('witch-modal')">‚Üê Quay l·∫°i</button>
    </div>
  </div>
</div>

<div id="guard-modal" class="modal-bg">
  <div class="modal">
    <span class="modal-icon">üõ°Ô∏è</span>
    <h2>B·∫£o V·ªá th·ª©c d·∫≠y!</h2>
    <p>Ch·ªçn 1 ng∆∞·ªùi b·∫£o v·ªá kh·ªèi s√≥i. Kh√¥ng b·∫£o v·ªá c√πng ng∆∞·ªùi 2 ƒë√™m li√™n ti·∫øp.</p>
    <div id="guard-targets" class="targets-grid"></div>
    <div class="modal-btns">
      <button id="guard-confirm-btn" class="mbtn p" onclick="guardConfirm()" disabled>üõ°Ô∏è B·∫£o v·ªá!</button>
      <button class="mbtn s" onclick="closeModal('guard-modal')">üò¥ B·ªè qua</button>
    </div>
  </div>
</div>

<div id="vamp-modal" class="modal-bg">
  <div class="modal">
    <span class="modal-icon">üßõ</span>
    <h2>Ma C√† R·ªìng th·ª©c d·∫≠y!</h2>
    <p>Ch·ªçn ng∆∞·ªùi h√∫t m√°u. N·∫°n nh√¢n ch·∫øt sau b·ªè phi·∫øu ng√†y mai.</p>
    <div id="vamp-targets" class="targets-grid"></div>
    <div class="modal-btns">
      <button id="vamp-confirm-btn" class="mbtn p" onclick="vampireConfirm()" disabled>üßõ H√∫t m√°u!</button>
      <button class="mbtn s" onclick="closeModal('vamp-modal')">üò¥ B·ªè qua</button>
    </div>
  </div>
</div>

<div id="hunter-modal" class="modal-bg">
  <div class="modal">
    <span class="modal-icon">üèπ</span>
    <h2>Th·ª£ SƒÉn ra tay!</h2>
    <p>B·∫°n s·∫Øp ch·∫øt! Ch·ªçn ngay 1 ng∆∞·ªùi ƒë·ªÉ b·∫Øn h·∫° tr∆∞·ªõc khi ch·∫øt!</p>
    <div id="hunter-timer" style="font-size:32px;color:var(--crimson);text-align:center;font-weight:900;margin:8px 0;">10s</div>
    <div id="hunter-targets" class="targets-grid"></div>
    <div class="modal-btns"><button id="hunter-fire-btn" class="mbtn p" onclick="hunterFire()" disabled>üèπ B·∫Øn!</button></div>
  </div>
</div>

<div id="notif" class="notif"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
// ================================================================
//  MA S√ìI ONLINE - Client
// ================================================================
const ROLES = {
  villager:{ id:'villager', name:'D√¢n L√†ng',    icon:'üë®‚Äçüåæ', team:'village', desc:'Kh√¥ng c√≥ ch·ª©c nƒÉng ƒë·∫∑c bi·ªát. Th·∫Øng khi lo·∫°i b·ªè h·∫øt k·∫ª th√π.', ability:'B·ªè phi·∫øu treo c·ªï ban ng√†y.' },
  wolf:    { id:'wolf',     name:'Ma S√≥i',       icon:'üê∫',  team:'wolf',    desc:'M·ªói ƒë√™m vote ch·ªçn n·∫°n nh√¢n c√πng b·∫ßy. Th·∫Øng khi s·ªë s√≥i ‚â• s·ªë c√≤n l·∫°i.', ability:'ƒê√™m: vote ch·ªçn n·∫°n nh√¢n.' },
  seer:    { id:'seer',     name:'Ti√™n Tri',     icon:'üîÆ',  team:'village', desc:'M·ªói ƒë√™m xem b·∫£n ch·∫•t 1 ng∆∞·ªùi ‚Äî c√≥ ph·∫£i Ma S√≥i kh√¥ng.', ability:'ƒê√™m: nh√¨n th·∫•u 1 ng∆∞·ªùi.' },
  witch:   { id:'witch',    name:'Ph√π Th·ªßy',     icon:'üßô‚Äç‚ôÄÔ∏è', team:'village', desc:'1 b√¨nh thu·ªëc duy nh·∫•t c·∫£ game: c·ª©u ng∆∞·ªùi ho·∫∑c gi·∫øt ng∆∞·ªùi.', ability:'1 l·∫ßn/game: c·ª©u ho·∫∑c gi·∫øt.' },
  hunter:  { id:'hunter',  name:'Th·ª£ SƒÉn',      icon:'üèπ',  team:'village', desc:'Khi ch·∫øt c√≥ 10 gi√¢y b·∫Øn h·∫° 1 ng∆∞·ªùi. N·∫øu kh√¥ng ch·ªçn k·ªãp m·∫•t ch·ª©c nƒÉng.', ability:'Khi ch·∫øt: b·∫Øn 1 ng∆∞·ªùi (10 gi√¢y).' },
  guard:   { id:'guard',   name:'B·∫£o V·ªá',       icon:'üõ°Ô∏è',  team:'village', desc:'M·ªói ƒë√™m b·∫£o v·ªá 1 ng∆∞·ªùi kh·ªèi s√≥i c·∫Øn. Kh√¥ng b·∫£o v·ªá c√πng ng∆∞·ªùi 2 ƒë√™m li√™n ti·∫øp. C√≥ th·ªÉ t·ª± b·∫£o v·ªá.', ability:'ƒê√™m: b·∫£o v·ªá 1 ng∆∞·ªùi.' },
  cursed:  { id:'cursed',  name:'K·∫ª B·ªã Nguy·ªÅn', icon:'üòà',  team:'village', desc:'Ban ƒë·∫ßu l√† d√¢n l√†ng. N·∫øu b·ªã s√≥i c·∫Øn s·∫Ω bi·∫øn th√†nh Ma S√≥i thay v√¨ ch·∫øt.', ability:'Bi·∫øn th√†nh s√≥i khi b·ªã c·∫Øn.' },
  bored:   { id:'bored',   name:'K·∫ª Ch√°n ƒê·ªùi',  icon:'üòë',  team:'none',    desc:'Ch·ªâ th·∫Øng khi b·ªã l√†ng treo c·ªï. Kh√¥ng thu·ªôc phe n√†o.', ability:'M·ª•c ti√™u: b·ªã l√†ng treo c·ªï.' },
  vampire: { id:'vampire', name:'Ma C√† R·ªìng',   icon:'üßõ',  team:'none',    desc:'M·ªói ƒë√™m h√∫t m√°u 1 ng∆∞·ªùi. N·∫°n nh√¢n ch·∫øt sau b·ªè phi·∫øu ng√†y h√¥m sau.', ability:'ƒê√™m: h√∫t m√°u (ch·∫øt tr√¨ ho√£n).' }
};
const ROLE_ORDER = ['wolf','vampire','guard','seer','witch','hunter','cursed','bored','villager'];
const AVATARS = ['üê±','ü¶ä','üêª','ü¶Å','üêØ','üê∫','ü¶ù','üê∏','ü¶Ñ','üêô','ü¶ã','üêß','ü¶Ö','üê≤','ü¶Ä','üê¨','ü¶â','üêº','ü¶å','üê®'];

let socket, myId, myName, myAvatar, myRole;
let currentCode = '';
let isHost      = false;
let gameState   = null; // sanitized public state from server
let pendingVoteTarget = null;
let timerInterval = null;
let roleConfig  = { wolf:1, seer:1, witch:1, hunter:1, guard:1, cursed:0, bored:0, vampire:0, villager:0 };

// ---- SOCKET SETUP ----
function initSocket() {
  socket = io({ transports: ['websocket', 'polling'] });

  socket.on('connect',    () => { myId = socket.id; });
  socket.on('disconnect', () => notify('M·∫•t k·∫øt n·ªëi server!', 'err'));
  socket.on('ERR',        d  => notify(d.msg, 'err'));

  socket.on('ROOM_JOINED', d => {
    currentCode = d.code;
    myId        = d.me.id;
    isHost      = d.me.isHost;
    updateRoomUI(d.room);
    showScreen('room');
    if (isHost) setupConfig();
  });

  socket.on('ROOM_UPDATE', d => updateRoomUI(d.room));

  socket.on('YOUR_ROLE', d => {
    myRole = d.role;
    renderMyRole();
    showRoleModal(d.role);
  });

  socket.on('CURSED_TURNED', d => {
    myRole = 'wolf';
    notify(d.msg, 'err');
    renderMyRole();
    showRoleModal('wolf');
  });

  socket.on('GAME_STARTED', d => {
    gameState = d.gameState;
    clearLog(); // Fix 6: clear stale log from previous game
    showScreen('game');
    renderGameUI();
    renderRoleInfoCol(); // Fix 4: show role list
  });

  socket.on('PHASE_CHANGE', d => {
    gameState = d.gameState;
    renderPhase(d.phase);
    renderGameUI();
  });

  socket.on('STATE_UPDATE', d => {
    gameState = d.gameState;
    renderGameUI();
  });

  // Fix 1: server sends TIMER_START with secs count
  socket.on('TIMER_START', d => {
    startClientTimer(d.secs);
  });

  socket.on('NIGHT_TURN', d => onNightTurn(d));

  socket.on('WOLF_VOTE_UPDATE', d => updateWolfVoteUI(d));

  socket.on('SEER_ANSWER', d => {
    const txt = d.isEvil
      ? `üê∫ ${d.targetName} l√† MA S√ìI!`
      : `‚úÖ ${d.targetName} l√† D√ÇN L√ÄNG (kh√¥ng ph·∫£i s√≥i).`;
    document.getElementById('seer-result-text').textContent = txt;
    document.getElementById('seer-result-text').className = 'seer-result ' + (d.isEvil ? 'evil' : 'good');
    openModal('seer-result-modal');
    appendLog(`üîÆ ${txt}`, d.isEvil ? 'wolf' : 'day');
  });

  socket.on('YOU_DIED', d => {
    const reasons = { wolf:'B·∫°n b·ªã Ma S√≥i ƒÉn th·ªãt trong ƒë√™m.', vote:'L√†ng ƒë√£ treo c·ªï b·∫°n.', witch:'B·∫°n b·ªã Ph√π Th·ªßy ƒë·∫ßu ƒë·ªôc.', hunter:'B·∫°n b·ªã Th·ª£ SƒÉn b·∫Øn.', night:'B·∫°n ƒë√£ ch·∫øt trong ƒë√™m.' };
    document.getElementById('death-reason').textContent = reasons[d.reason] || 'B·∫°n ƒë√£ b·ªã lo·∫°i!';
    const r = ROLES[d.role];
    document.getElementById('death-role').textContent = r ? `Vai c·ªßa b·∫°n: ${r.icon} ${r.name}` : '';
    openModal('death-modal');
  });

  socket.on('HUNTER_TURN', d => showHunterModal(d.targets));

  socket.on('LOG',      d => appendLog(d.msg, d.cls));
  socket.on('CHAT_MSG', d => appendLog(`üí¨ ${d.from}: ${d.msg}`, 'chat'));

  socket.on('GAME_OVER', d => showEndScreen(d));
}

// ---- LOBBY ----
function createRoom() {
  const name = document.getElementById('inp-name').value.trim();
  if (!name) return notify('H√£y nh·∫≠p t√™n!', 'err');
  myName   = name;
  myAvatar = AVATARS[name.charCodeAt(0) % AVATARS.length];
  socket.emit('CREATE_ROOM', { name, avatar: myAvatar });
}

function joinRoom() {
  const name = document.getElementById('inp-name').value.trim();
  const code = document.getElementById('inp-code').value.trim().toUpperCase();
  if (!name)          return notify('H√£y nh·∫≠p t√™n!', 'err');
  if (code.length !== 6) return notify('M√£ ph√≤ng c·∫ßn ƒë√∫ng 6 k√Ω t·ª±!', 'err');
  myName   = name;
  myAvatar = AVATARS[name.charCodeAt(0) % AVATARS.length];
  socket.emit('JOIN_ROOM', { code, name, avatar: myAvatar });
}

function leaveRoom() {
  socket.disconnect(); socket.connect();
  gameState = null; myRole = null; isHost = false;
  clearTimerUI(); showScreen('lobby');
}

function leaveGame() {
  if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën tho√°t?')) leaveRoom();
}

function copyCode() {
  navigator.clipboard.writeText(currentCode).catch(() => {});
  notify('ƒê√£ sao ch√©p: ' + currentCode, 'ok');
}

// ---- ROOM UI ----
function updateRoomUI(room) {
  document.getElementById('room-code').textContent = room.code;
  document.getElementById('room-pc').textContent   = room.players.length + ' ng∆∞·ªùi';
  const g = document.getElementById('room-grid');
  g.innerHTML = room.players.map(p => `
    <div class="pcard ${p.id === room.hostId ? 'host' : ''} ${p.id === myId ? 'me' : ''}">
      <div class="pavatar">${p.avatar}</div>
      <div class="pname">${escH(p.name)}</div>
      <div class="pbadge">${p.id === room.hostId ? 'üëë Ch·ªß ph√≤ng' : p.id === myId ? '(B·∫°n)' : '‚ú¶'}</div>
    </div>`).join('');
  const waitEl = document.getElementById('room-wait');
  if (isHost) {
    waitEl.textContent = 'Chia s·∫ª m√£ ph√≤ng cho b·∫°n b√®!';
    document.getElementById('cfg-panel').style.display = '';
    document.getElementById('start-btn').style.display = '';
    updateStartBtn(room.players.length);
  } else {
    waitEl.textContent = 'Ch·ªù ch·ªß ph√≤ng b·∫Øt ƒë·∫ßu...';
    document.getElementById('cfg-panel').style.display = 'none';
  }
}

function setupConfig() {
  const c = document.getElementById('cfg-roles');
  c.innerHTML = ROLE_ORDER.filter(r => r !== 'villager').map(rid => {
    const r = ROLES[rid];
    return `<div class="role-item" onclick="showRoleInfo('${rid}')" >
      <span class="rname">${r.icon} ${r.name} <span style="font-size:10px;opacity:.4">‚ìò</span></span>
      <div class="rcnt" onclick="event.stopPropagation()">
        <button class="cbtn" onclick="adjRole('${rid}',-1)">‚àí</button>
        <span id="rc-${rid}">${roleConfig[rid]||0}</span>
        <button class="cbtn" onclick="adjRole('${rid}',1)">+</button>
      </div>
    </div>`;
  }).join('');
}

function showRoleInfo(rid) {
  const r = ROLES[rid]; if (!r) return;
  document.getElementById('reveal-icon').textContent = r.icon;
  document.getElementById('reveal-name').textContent = r.name;
  document.getElementById('reveal-desc').textContent = r.desc;
  const tl = { village:'D√¢n L√†ng üü¶', wolf:'Ma S√≥i üî¥', none:'Trung L·∫≠p ‚ö´' };
  const tc = { village:'#64B4FF', wolf:'#FF4444', none:'#AAAAAA' };
  document.getElementById('reveal-team').textContent  = 'Phe: ' + (tl[r.team] || r.team);
  document.getElementById('reveal-team').style.color  = tc[r.team] || '#CCC';
  openModal('role-modal');
}

function adjRole(rid, d) {
  if (!isHost) return;
  let v = (roleConfig[rid]||0) + d;
  if (rid === 'wolf' && v < 1) return;
  roleConfig[rid] = Math.max(0, v);
  const el = document.getElementById('rc-' + rid);
  if (el) el.textContent = roleConfig[rid];
  updateStartBtn(document.getElementById('room-pc').textContent.replace(/[^0-9]/g,'') * 1);
}

function updateStartBtn(np) {
  const special = ROLE_ORDER.filter(r => r !== 'villager').reduce((s,r) => s + (roleConfig[r]||0), 0);
  const w = roleConfig.wolf || 0;
  const btn = document.getElementById('start-btn');
  const msg = document.getElementById('start-msg');
  if (!btn) return;
  if (np < Math.max(4, w+2)) {
    btn.disabled = true; btn.textContent = 'üåô C·∫ßn th√™m ng∆∞·ªùi';
    msg.textContent = `C·∫ßn √≠t nh·∫•t ${Math.max(4,w+2)} ng∆∞·ªùi.`;
  } else if (special > np) {
    btn.disabled = true; btn.textContent = '‚ö† Qu√° nhi·ªÅu vai';
    msg.textContent = 'Gi·∫£m s·ªë vai ƒë·∫∑c bi·ªát xu·ªëng.';
  } else {
    btn.disabled = false; btn.textContent = 'üåô B·∫Øt ƒë·∫ßu Game';
    msg.textContent = `${np} ng∆∞·ªùi ¬∑ ${w} s√≥i ¬∑ ${np - special} d√¢n l√†ng`;
  }
}

function startGame() {
  if (!isHost) return;
  const discussTime = parseInt(document.getElementById('discuss-time-select').value) || 60;
  socket.emit('START_GAME', { code: currentCode, roleConfig, discussTime });
}

// ---- GAME RENDER ----
function renderGameUI() {
  if (!gameState) return;
  const alive = gameState.players.filter(p => p.alive);
  const dead  = gameState.players.filter(p => !p.alive);
  document.getElementById('alive-cnt').textContent = alive.length;
  document.getElementById('dead-cnt').textContent  = dead.length;
  renderPlayerList('alive-list', alive, false);
  renderPlayerList('dead-list',  dead,  true);
  renderActionPanel();
}

function renderPlayerList(cid, players, isDead) {
  const c = document.getElementById(cid); if (!c) return;
  const me      = gameState.players.find(p => p.id === myId);
  const amAlive = me && me.alive;
  const phase   = gameState.phase;

  c.innerHTML = players.map(p => {
    const vc   = (p.votes > 0 && !isDead) ? `<span class="vcnt">${p.votes}</span>` : '';
    const meTag= p.id === myId ? ' <span class="tag-me">B·∫°n</span>' : '';
    // Role shown only to self; dead players show "‚Äî ·∫©n ‚Äî" to others
    const roleStr = p.id === myId && myRole ? (ROLES[myRole] ? `${ROLES[myRole].icon} ${ROLES[myRole].name}` : '') : '';
    const roleDiv = roleStr ? `<div class="gp-role">${roleStr}</div>` : `<div class="gp-role" style="opacity:.22">‚Äî ·∫©n ‚Äî</div>`;
    let clickable = '';
    if (amAlive && !isDead && p.id !== myId && phase === 'vote') clickable = 'can-target';
    const onclick = clickable ? `onclick="castVote('${p.id}')"` : '';
    return `<div class="gp ${isDead ? 'dead' : ''} ${clickable}" ${onclick} id="gpc-${p.id}">
      ${vc}
      <div class="gp-av">${p.avatar}</div>
      <div class="gp-name">${escH(p.name)}${meTag}</div>
      ${roleDiv}
    </div>`;
  }).join('');
}

function renderMyRole() {
  if (!myRole) return;
  const r = ROLES[myRole]; if (!r) return;
  document.getElementById('my-role-icon').textContent    = r.icon;
  document.getElementById('my-role-name').textContent    = r.name;
  const tc = { village:'#64B4FF', wolf:'#FF4444', none:'#AAAAAA' };
  document.getElementById('my-role-team').textContent    = 'Phe: ' + (r.team === 'village' ? 'D√¢n L√†ng' : r.team === 'wolf' ? 'Ma S√≥i' : 'Trung L·∫≠p');
  document.getElementById('my-role-team').style.color    = tc[r.team] || '#CCC';
  document.getElementById('my-role-ability').textContent = r.ability;
}

function renderActionPanel() {
  const panel = document.getElementById('action-content'); if (!panel) return;
  const me = gameState?.players.find(p => p.id === myId);
  if (!me || !me.alive) { panel.innerHTML = '<span class="dim-text">B·∫°n ƒëang quan s√°t...</span>'; return; }
  const phase = gameState.phase;

  if (phase === 'day') {
    panel.innerHTML = '<span class="dim-text">Th·∫£o lu·∫≠n ƒë·ªÉ t√¨m ra Ma S√≥i!</span>';
  } else if (phase === 'vote') {
    const alive   = gameState.players.filter(p => p.alive).length;
    const needed  = Math.floor(alive / 2) + 1;
    const myVote  = gameState.votes ? gameState.votes[myId] : null;
    const vname   = myVote ? (gameState.players.find(p => p.id === myVote)?.name || '') : '';
    panel.innerHTML = `<div class="majority-indicator">C·∫ßn ‚â• ${needed}/${alive} phi·∫øu ƒë·ªÉ treo c·ªï</div>`
      + (vname ? `<span class="dim-text">Phi·∫øu c·ªßa b·∫°n: <strong style="color:var(--crimson)">${escH(vname)}</strong></span>` : '<span class="dim-text">Nh·∫•n v√†o ng∆∞·ªùi ch∆°i ƒë·ªÉ b·ªè phi·∫øu.</span>');
  } else if (phase === 'night') {
    const cur = gameState.currentNightRole;
    const eff = (myRole === 'cursed' && gameState.cursedTurned?.includes(myId)) ? 'wolf' : myRole;
    if (eff === cur || (eff === 'wolf' && cur === 'wolf')) {
      panel.innerHTML = '<span class="dim-text" style="color:var(--gold)">‚ú® ƒê·∫øn l∆∞·ª£t b·∫°n h√†nh ƒë·ªông...</span>';
    } else {
      const w = { wolf:'üê∫ Ma S√≥i ƒëang th·ª©c...', vampire:'üßõ Ma C√† R·ªìng ƒëang th·ª©c...', guard:'üõ°Ô∏è B·∫£o V·ªá ƒëang th·ª©c...', seer:'üîÆ Ti√™n Tri ƒëang th·ª©c...', witch:'üßô‚Äç‚ôÄÔ∏è Ph√π Th·ªßy ƒëang th·ª©c...' };
      panel.innerHTML = `<span class="dim-text">${w[cur] || 'ƒêang ch·ªù...'}</span>`;
    }
  }
}

function renderPhase(phase) {
  const map = {
    night: { icon:'üåô', title:'M√†n ƒê√™m',   sub:'C√°c vai ƒë·∫∑c bi·ªát ƒëang h√†nh ƒë·ªông...', cls:'night' },
    day:   { icon:'‚òÄÔ∏è', title:'Ban Ng√†y',   sub:'Th·∫£o lu·∫≠n ƒë·ªÉ t√¨m ra k·∫ª ƒë·ªãch!',      cls:'day'   },
    vote:  { icon:'‚öñ', title:'B·ªè Phi·∫øu',  sub:'Nh·∫•n v√†o ng∆∞·ªùi ƒë·ªÉ b·ªè phi·∫øu!',       cls:'vote'  },
  };
  const m = map[phase] || map.day;
  document.getElementById('phase-icon').textContent  = m.icon;
  document.getElementById('phase-title').textContent = m.title;
  document.getElementById('phase-sub').textContent   = m.sub;
  document.getElementById('phase-banner').className  = 'phase-banner ' + m.cls;
  document.body.className = phase === 'night' ? 'night-bg' : '';
}

// ---- TIMER (client display only) ----

// ---- NIGHT TURN HANDLERS ----
let wolfSel=null, seerSel=null, vampireSel=null, guardSel=null;

function onNightTurn(data) {
  const role = data.role;
  if (role === 'wolf')    showWolfModal(data);
  else if (role === 'seer')    showSeerModal(data);
  else if (role === 'witch')   showWitchModal(data);
  else if (role === 'guard')   showGuardModal(data);
  else if (role === 'vampire') showVampireModal(data);
}

function showWolfModal(data) {
  wolfSel = null;
  document.getElementById('wolf-pack-info').textContent = 'üê∫ B·∫ßy s√≥i: ' + data.pack;
  const c = document.getElementById('wolf-targets'); c.innerHTML = '';
  data.targets.forEach(t => {
    const b = document.createElement('button');
    b.className = 'target-btn';
    b.textContent = `${t.avatar} ${t.name}`;
    b.onclick = () => {
      wolfSel = t.id;
      document.querySelectorAll('#wolf-targets .target-btn').forEach(x => x.classList.remove('sel'));
      b.classList.add('sel');
      document.getElementById('wolf-confirm-btn').disabled = false;
      socket.emit('NIGHT_ACT', { code: currentCode, type: 'wolf', target: t.id });
    };
    c.appendChild(b);
  });
  document.getElementById('wolf-confirm-btn').disabled = true;
  document.getElementById('wolf-vote-status').innerHTML = '<span style="opacity:.5;font-size:12px">Ch∆∞a ai ch·ªçn...</span>';
  document.getElementById('wolf-consensus-label').textContent = '';
  openModal('wolf-modal');
}

function updateWolfVoteUI(data) {
  const container = document.getElementById('wolf-vote-status'); if (!container) return;
  const lines = Object.entries(data.votes || {}).map(([wid, tid]) => {
    const wp = gameState?.players.find(p => p.id === wid);
    const tp = gameState?.players.find(p => p.id === tid);
    if (!wp || !tp) return '';
    const me = wid === myId ? ' (b·∫°n)' : '';
    return `<div style="font-size:12px;color:#FFA0A0">${wp.name}${me} ‚Üí ${tp.name}</div>`;
  }).filter(Boolean).join('');
  container.innerHTML = lines || '<span style="opacity:.5;font-size:12px">Ch∆∞a ai ch·ªçn...</span>';
  if (data.wolfTarget) {
    const tp = gameState?.players.find(p => p.id === data.wolfTarget);
    const lbl = document.getElementById('wolf-consensus-label');
    if (lbl && tp) lbl.textContent = `‚úÖ ƒê·ªìng thu·∫≠n: ${tp.name}`;
  } else {
    const lbl = document.getElementById('wolf-consensus-label');
    if (lbl) lbl.textContent = '';
  }
}

function wolfConfirm() {
  if (!wolfSel) return;
  socket.emit('NIGHT_ACT', { code: currentCode, type: 'wolf', target: wolfSel });
  closeModal('wolf-modal');
}

function showSeerModal(data) {
  seerSel = null;
  const c = document.getElementById('seer-targets'); c.innerHTML = '';
  data.targets.forEach(t => {
    const b = document.createElement('button');
    b.className = 'target-btn'; b.textContent = `${t.avatar} ${t.name}`;
    b.onclick = () => {
      seerSel = t.id;
      document.querySelectorAll('#seer-targets .target-btn').forEach(x => x.classList.remove('sel'));
      b.classList.add('sel');
      document.getElementById('seer-confirm-btn').disabled = false;
    };
    c.appendChild(b);
  });
  document.getElementById('seer-confirm-btn').disabled = true;
  openModal('seer-modal');
}

function seerConfirm() {
  if (!seerSel) return;
  socket.emit('NIGHT_ACT', { code: currentCode, type: 'seer', target: seerSel });
  closeModal('seer-modal');
}

function showWitchModal(data) {
  const used = data.witchPotionUsed;
  document.getElementById('witch-attacked-info').textContent = data.wasAttacked
    ? 'ü©∏ S√≥i ƒë√™m nay ƒë√£ t·∫•n c√¥ng ai ƒë√≥.'
    : '‚ú® S√≥i kh√¥ng t·∫•n c√¥ng ai ƒë√™m nay.';
  const sb = document.getElementById('witch-save-btn');
  const kb = document.getElementById('witch-kill-open-btn');
  if (sb) { sb.disabled = used || !data.wasAttacked; sb.textContent = used ? 'üíä ƒê√£ d√πng b√¨nh thu·ªëc' : data.wasAttacked ? 'üíä C·ª©u ng∆∞·ªùi b·ªã t·∫•n c√¥ng' : 'üíä Kh√¥ng c√≥ ai ƒë·ªÉ c·ª©u'; }
  if (kb) { kb.disabled = used; kb.textContent = used ? '‚ò† ƒê√£ d√πng b√¨nh thu·ªëc' : '‚ò† D√πng b√¨nh ƒë·ªôc (gi·∫øt ng∆∞·ªùi)'; }
  window._witchKillTargets = data.killTargets || [];
  openModal('witch-modal');
}

function doWitchSave() {
  socket.emit('WITCH_SAVE', { code: currentCode });
  closeModal('witch-modal');
  appendLog('üßô‚Äç‚ôÄÔ∏è B·∫°n ƒë√£ d√πng b√¨nh c·ª©u ng∆∞·ªùi.', 'night');
}

function showWitchKillModal() {
  closeModal('witch-modal');
  const targets = window._witchKillTargets || [];
  const c = document.getElementById('witch-kill-targets'); c.innerHTML = '';
  let sel = null;
  targets.forEach(t => {
    const b = document.createElement('button');
    b.className = 'target-btn'; b.textContent = `${t.avatar} ${t.name}`;
    b.onclick = () => {
      sel = t.id;
      document.querySelectorAll('#witch-kill-targets .target-btn').forEach(x => x.classList.remove('sel'));
      b.classList.add('sel');
      document.getElementById('witch-kill-confirm').disabled = false;
    };
    c.appendChild(b);
  });
  document.getElementById('witch-kill-confirm').disabled = true;
  document.getElementById('witch-kill-confirm').onclick = () => {
    if (!sel) return;
    socket.emit('WITCH_KILL', { code: currentCode, target: sel });
    closeModal('witch-kill-modal');
    appendLog('üßô‚Äç‚ôÄÔ∏è B·∫°n ƒë√£ d√πng b√¨nh ƒë·ªôc.', 'night');
  };
  openModal('witch-kill-modal');
}

function showGuardModal(data) {
  guardSel = null;
  const c = document.getElementById('guard-targets'); c.innerHTML = '';
  const last = data.lastProtected;
  data.targets.forEach(t => {
    const isLast = t.id === last;
    const b = document.createElement('button');
    b.className = 'target-btn' + (isLast ? '' : '');
    b.textContent = `${t.avatar} ${t.name}${isLast ? ' (ƒë√™m tr∆∞·ªõc)' : ''}`;
    b.disabled = isLast;
    if (isLast) b.style.opacity = '.4';
    else b.onclick = () => {
      guardSel = t.id;
      document.querySelectorAll('#guard-targets .target-btn').forEach(x => x.classList.remove('sel'));
      b.classList.add('sel');
      document.getElementById('guard-confirm-btn').disabled = false;
    };
    c.appendChild(b);
  });
  document.getElementById('guard-confirm-btn').disabled = true;
  openModal('guard-modal');
}

function guardConfirm() {
  if (!guardSel) return;
  socket.emit('GUARD_ACT', { code: currentCode, target: guardSel });
  closeModal('guard-modal');
  appendLog('üõ°Ô∏è B·∫°n ƒë√£ ch·ªçn ng∆∞·ªùi b·∫£o v·ªá.', 'night');
}

function showVampireModal(data) {
  vampireSel = null;
  const c = document.getElementById('vamp-targets'); c.innerHTML = '';
  data.targets.forEach(t => {
    const b = document.createElement('button');
    b.className = 'target-btn'; b.textContent = `${t.avatar} ${t.name}`;
    b.onclick = () => {
      vampireSel = t.id;
      document.querySelectorAll('#vamp-targets .target-btn').forEach(x => x.classList.remove('sel'));
      b.classList.add('sel');
      document.getElementById('vamp-confirm-btn').disabled = false;
    };
    c.appendChild(b);
  });
  document.getElementById('vamp-confirm-btn').disabled = true;
  openModal('vamp-modal');
}

function vampireConfirm() {
  if (!vampireSel) return;
  socket.emit('NIGHT_ACT', { code: currentCode, type: 'vampire', target: vampireSel });
  closeModal('vamp-modal');
}

// ---- HUNTER ----
let hunterTimerIV = null;
function showHunterModal(targets) {
  const c = document.getElementById('hunter-targets'); c.innerHTML = '';
  let sel = null;
  targets.forEach(t => {
    const b = document.createElement('button');
    b.className = 'target-btn'; b.textContent = `${t.avatar} ${t.name}`;
    b.onclick = () => {
      sel = t.id;
      document.querySelectorAll('#hunter-targets .target-btn').forEach(x => x.classList.remove('sel'));
      b.classList.add('sel');
      document.getElementById('hunter-fire-btn').disabled = false;
    };
    c.appendChild(b);
  });
  document.getElementById('hunter-fire-btn').disabled = true;
  document.getElementById('hunter-fire-btn').onclick = () => {
    if (!sel) return;
    socket.emit('HUNTER_SHOT', { code: currentCode, target: sel });
    clearInterval(hunterTimerIV);
    closeModal('hunter-modal');
  };
  openModal('hunter-modal');
  let rem = 10;
  const te = document.getElementById('hunter-timer');
  if (te) te.textContent = rem + 's';
  hunterTimerIV = setInterval(() => {
    rem--;
    if (te) te.textContent = rem + 's';
    if (rem <= 0) { clearInterval(hunterTimerIV); closeModal('hunter-modal'); }
  }, 1000);
}

// ---- VOTE ----
function castVote(targetId) {
  if (!gameState || gameState.phase !== 'vote') return;
  const me = gameState.players.find(p => p.id === myId);
  if (!me || !me.alive) return;
  document.getElementById('vote-confirm-name').textContent = gameState.players.find(p => p.id === targetId)?.name || '';
  pendingVoteTarget = targetId;
  openModal('vote-modal');
}

function confirmVote() {
  if (!pendingVoteTarget) return;
  socket.emit('VOTE_CAST', { code: currentCode, target: pendingVoteTarget });
  closeModal('vote-modal');
  pendingVoteTarget = null;
}

// ---- CHAT ----
function sendChat() {
  const inp = document.getElementById('chat-inp');
  const msg = inp.value.trim(); if (!msg) return;
  inp.value = '';
  // Fix 5: don't log locally ‚Äî server will echo CHAT_MSG back to all including sender
  socket.emit('CHAT', { code: currentCode, msg });
}

// ---- END SCREEN ----
function showRoleModal(role) {
  const r = ROLES[role]; if (!r) return;
  document.getElementById('reveal-icon').textContent = r.icon;
  document.getElementById('reveal-name').textContent = r.name;
  document.getElementById('reveal-desc').textContent = r.desc;
  const tl = { village:'D√¢n L√†ng üü¶', wolf:'Ma S√≥i üî¥', none:'Trung L·∫≠p ‚ö´' };
  const tc = { village:'#64B4FF', wolf:'#FF4444', none:'#AAAAAA' };
  document.getElementById('reveal-team').textContent = 'Phe: ' + (tl[r.team] || r.team);
  document.getElementById('reveal-team').style.color  = tc[r.team] || '#CCC';
  openModal('role-modal');
}

function showEndScreen(data) {
  clearTimerUI();
  const t = { village:'üèÜ', wolf:'üê∫', vampire:'üßõ', bored:'üòë' };
  document.getElementById('end-trophy').textContent = t[data.winner] || 'üèÜ';
  document.getElementById('end-title').textContent  = data.msg || 'Tr√≤ ch∆°i k·∫øt th√∫c!';
  document.getElementById('end-winners').innerHTML  = (data.names||[]).map(n => `<span class="winner-chip">${n}</span>`).join('');
  const rp = document.getElementById('end-roles');
  if (data.allPlayers && rp) {
    rp.innerHTML = data.allPlayers.map(p => {
      const r = ROLES[p.role];
      return `<div class="end-player ${p.alive ? 'alive' : 'dead'}">
        <span>${p.avatar}</span><span style="flex:1">${escH(p.name)}</span>
        <span>${r ? r.icon + ' ' + r.name : ''}</span>
      </div>`;
    }).join('');
  }
  showScreen('end');
}

function returnToLobby() {
  gameState = null; myRole = null;
  clearTimerUI(); showScreen('lobby');
}

// ---- HELPERS ----
function appendLog(msg, cls='sys') {
  const c = document.getElementById('log-msgs'); if (!c) return;
  const d = document.createElement('div');
  d.className = 'log-line ' + cls; d.textContent = msg;
  c.appendChild(d); c.scrollTop = c.scrollHeight;
}

// Fix 6: clear log between games
function clearLog() {
  const c = document.getElementById('log-msgs');
  if (c) c.innerHTML = '';
}

// Fix 4: render role info column
function renderRoleInfoCol() {
  const c = document.getElementById('role-info-list'); if (!c) return;
  if (!gameState?.roleConfig) { c.innerHTML = ''; return; }
  const cfg = gameState.roleConfig || {};
  // Count from players since roleConfig may not be in pub()
  // Fallback: gather from actual players (we know roles from allPlayers at endgame)
  // During game, use roleConfig attached to gameState if present, else skip
  const allRoles = ['wolf','vampire','guard','seer','witch','hunter','cursed','bored','villager'];
  const rows = allRoles.map(rid => {
    const cnt = cfg[rid] || 0;
    if (cnt === 0) return '';
    const r = ROLES[rid];
    return `<div class="ri-row">
      <span class="ri-row-icon">${r.icon}</span>
      <div class="ri-row-info">
        <div class="ri-row-name">${r.name}</div>
        <div class="ri-row-cnt">SL: <span>${cnt}</span></div>
      </div>
    </div>`;
  }).join('');
  c.innerHTML = rows || '<div class="ri-row-name" style="font-size:11px;color:var(--silver);padding:4px">Ch∆∞a c√≥ th√¥ng tin</div>';
}

// Fix 1: client timer countdown
function startClientTimer(secs) {
  clearTimerUI();
  const end = Date.now() + secs * 1000;
  const el  = document.getElementById('timer');
  timerInterval = setInterval(() => {
    const rem = Math.max(0, Math.round((end - Date.now()) / 1000));
    if (el) { el.textContent = rem + 's'; el.className = 'timer' + (rem <= 10 ? ' warn' : ''); }
    if (rem === 0) clearTimerUI();
  }, 250);
}

function clearTimerUI() {
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  const el = document.getElementById('timer');
  if (el) el.textContent = '';
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const s = document.getElementById('scr-' + id);
  if (s) s.classList.add('active');
}

function openModal(id)  { const m = document.getElementById(id); if (m) m.style.display = 'flex'; }
function closeModal(id) { const m = document.getElementById(id); if (m) m.style.display = 'none'; }
function escH(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

let notifTO = null;
function notify(msg, type='') {
  const el = document.getElementById('notif'); if (!el) return;
  el.textContent = msg;
  el.className = 'notif ' + (type==='err'?'error':type==='ok'?'success':'');
  el.classList.add('show');
  if (notifTO) clearTimeout(notifTO);
  notifTO = setTimeout(() => el.classList.remove('show'), 3000);
}

// ---- KEYBOARD ----
document.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    const scr = document.querySelector('.screen.active');
    if (scr?.id === 'scr-lobby') {
      document.getElementById('inp-code').value.trim() ? joinRoom() : createRoom();
    } else if (scr?.id === 'scr-game') {
      sendChat();
    }
  }
});

// ---- INIT ----
initSocket();
</script>
</body>
</html>
